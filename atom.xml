<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[简洁的想法]]></title>
  <link href="http://ZPVIP.github.io/atom.xml" rel="self"/>
  <link href="http://ZPVIP.github.io/"/>
  <updated>2016-06-16T16:18:45+02:00</updated>
  <id>http://ZPVIP.github.io/</id>
  <author>
    <name><![CDATA[Peter]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[在 Mac 下用 Homebrew 安装 MySQL]]></title>
    <link href="http://ZPVIP.github.io/posts/2014/01/27/install-mysql-using-homebrew/"/>
    <updated>2014-01-27T21:27:00+01:00</updated>
    <id>http://ZPVIP.github.io/posts/2014/01/27/install-mysql-using-homebrew</id>
    <content type="html"><![CDATA[<p>在 Mac 下用 Homebrew 安装 MySQL, 网上的教程倒是很多，不过大多数都很默契地雷同。如果稍有点定制要求，就无从下手了。</p>

<p>我先也不免俗，从基本的开始：</p>

<h2>一、首先安装 Homebrew</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ruby -e <span class="s2">&quot;$(curl -fsSL https://raw.github.com/mxcl/homebrew/go)&quot;</span>
</span><span class='line'><span class="nv">$ </span>brew install git
</span><span class='line'><span class="nv">$ </span>brew update
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>二、安装 MySQL</h2>

<p>用下面的命令就可以自动安装了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install mysql
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>如果想让 MySQL 开机自动启动，可以如下操作：</p>

<!--more-->


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p ~/Library/LaunchAgents
</span><span class='line'><span class="nv">$ </span>ln -sfv /usr/local/opt/mysql/*.plist ~/Library/LaunchAgents
</span><span class='line'><span class="nv">$ </span>find /usr/local/Cellar/mysql/ -name <span class="s2">&quot;homebrew.mxcl.mysql.plist&quot;</span> -exec cp <span class="o">{}</span> ~/Library/LaunchAgents/ <span class="se">\;</span>
</span><span class='line'><span class="nv">$ </span>launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.mysql.plist
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>设置 MySQL 用户以及数据存放地址</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">unset </span>TMPDIR
</span><span class='line'><span class="nv">$ </span>mysql_install_db --verbose --user<span class="o">=</span><span class="sb">`</span>whoami<span class="sb">`</span> --basedir<span class="o">=</span><span class="s2">&quot;$(brew --prefix mysql)&quot;</span> --datadir<span class="o">=</span>/usr/local/var/mysql --tmpdir<span class="o">=</span>/tmp
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>好了，可以启动了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mysql.server start
</span></code></pre></td></tr></table></div></figure>


<p>
另外的参数还有 <code>{start|stop|restart|reload|force-reload|status}</code></p>

<p>大部分的介绍就在此结束了。</p>

<h2>三、更详细的设置</h2>

<h3>配置文件 my.cnf</h3>

<p>作为用惯了 Linux 的人， 一定会去 <code>/etc</code> 下找 <code>my.cnf</code>, 让你失望了，这个文件要自己建立。如果看一下帮助</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mysqld --help --verbose
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>就会发现系统会按这个顺序去找 my.cnf</p>

<ol>
<li>/etc/my.cnf</li>
<li>/etc/mysql/my.cnf</li>
<li>/usr/local/etc/my.cnf</li>
<li>~/.my.cnf</li>
</ol>


<p>一般网上大虾都会这么教小白建立 my.cnf, 其实这个默认的文件里面几乎没什么内容。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo cp <span class="k">$(</span>brew --prefix mysql<span class="k">)</span>/support-files/my-default.cnf /etc/my.cnf
</span></code></pre></td></tr></table></div></figure>


<p>
所以，还是自己老老实实参考 linux 下的配置文件吧。</p>

<figure class='code'><figcaption><span>my.cnf  (my.cnf.txt)</span> <a href='http://ZPVIP.github.io/attachment/code/mysql/my.cnf.txt'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># The MySQL database server configuration file.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You can copy this to one of:</span>
</span><span class='line'><span class="c"># - &quot;/etc/mysql/my.cnf&quot; to set global options,</span>
</span><span class='line'><span class="c"># - &quot;~/.my.cnf&quot; to set user-specific options.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># One can use all long options that the program supports.</span>
</span><span class='line'><span class="c"># Run program with --help to get a list of available options and with</span>
</span><span class='line'><span class="c"># --print-defaults to see which it would actually understand and use.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># For explanations see</span>
</span><span class='line'><span class="c"># http://dev.mysql.com/doc/mysql/en/server-system-variables.html</span>
</span><span class='line'>
</span><span class='line'><span class="c"># This will be passed to all mysql clients</span>
</span><span class='line'><span class="c"># It has been reported that passwords should be enclosed with </span>
</span><span class='line'><span class="c"># ticks/quotes escpecially if they contain &quot;#&quot; chars...</span>
</span><span class='line'><span class="c"># Remember to edit /etc/mysql/debian.cnf when changing </span>
</span><span class='line'><span class="c"># the socket location.</span>
</span><span class='line'><span class="err">[client]</span>
</span><span class='line'><span class="nb">port</span>        = <span class="m">3306</span>
</span><span class='line'><span class="c">#socket     = /var/run/mysqld/mysqld.sock</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Here is entries for some specific programs</span>
</span><span class='line'><span class="c"># The following values assume you have at least 32M ram</span>
</span><span class='line'>
</span><span class='line'><span class="c"># This was formally known as [safe_mysqld]. Both versions </span>
</span><span class='line'><span class="c"># are currently parsed.</span>
</span><span class='line'><span class="err">[mysqld_safe]</span>
</span><span class='line'><span class="c">#socket     = /var/run/mysqld/mysqld.sock</span>
</span><span class='line'><span class="c">#nice       = 0</span>
</span><span class='line'>
</span><span class='line'><span class="err">[mysqld]</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># * Basic Settings</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># * IMPORTANT</span>
</span><span class='line'><span class="c">#   If you make changes to these settings and your system uses </span>
</span><span class='line'><span class="c">#   apparmor, you may also need to also adjust </span>
</span><span class='line'><span class="c">#   /etc/apparmor.d/usr.sbin.mysqld.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'><span class="c">#user       = mysql</span>
</span><span class='line'><span class="c">#socket     = /var/run/mysqld/mysqld.sock</span>
</span><span class='line'><span class="nb">port</span>        = <span class="m">3306</span>
</span><span class='line'><span class="c">#basedir    = /usr</span>
</span><span class='line'><span class="nb">datadir</span>    = <span class="sx">/usr/local/var/mysql</span>
</span><span class='line'><span class="c">#tmpdir     = /tmp</span>
</span><span class='line'><span class="err">skip-external-</span><span class="nb">locking</span>
</span><span class='line'>#
</span><span class='line'><span class="c"># Instead of skip-networking the default is now to listen only on</span>
</span><span class='line'><span class="c"># localhost which is more compatible and is not less secure.</span>
</span><span class='line'><span class="err">bind-</span><span class="nb">address</span>        = <span class="m">127.0.0.1</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># * Fine Tuning</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="err">key_</span><span class="nb">buffer</span>          = <span class="m">16</span>M
</span><span class='line'><span class="err">max_allowed_</span><span class="nb">packet</span>  = <span class="m">16</span>M
</span><span class='line'><span class="err">thread_</span><span class="nb">stack</span>        = <span class="m">192</span>K
</span><span class='line'><span class="err">thread_cache_</span><span class="nb">size</span>   = <span class="m">8</span>
</span><span class='line'><span class="c"># This replaces the startup script and checks MyISAM tables if needed</span>
</span><span class='line'><span class="c"># the first time they are touched</span>
</span><span class='line'><span class="err">myisam-</span><span class="nb">recover</span>         = BACKUP
</span><span class='line'><span class="c">#max_connections       = 100</span>
</span><span class='line'><span class="c">#table_cache           = 64</span>
</span><span class='line'><span class="c">#thread_concurrency    = 10</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># * Query Cache Configuration</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="err">query_cache_</span><span class="nb">limit</span>   = <span class="m">1</span>M
</span><span class='line'><span class="err">query_cache_</span><span class="nb">size</span>    = <span class="m">16</span>M
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># * Logging and Replication</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Both location gets rotated by the cronjob.</span>
</span><span class='line'><span class="c"># Be aware that this log type is a performance killer.</span>
</span><span class='line'><span class="c"># As of 5.1 you can enable the log at runtime!</span>
</span><span class='line'><span class="c">#general_log_file        = /var/log/mysql/mysql.log</span>
</span><span class='line'><span class="c">#general_log             = 1</span>
</span><span class='line'>
</span><span class='line'><span class="err">log_</span><span class="nb">error</span>                = <span class="sx">/usr/local/var/mysql/MacBook15.local.err</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Here you can see queries with especially long duration</span>
</span><span class='line'><span class="c">#log_slow_queries   = /var/log/mysql/mysql-slow.log</span>
</span><span class='line'><span class="c">#long_query_time = 2</span>
</span><span class='line'><span class="c">#log-queries-not-using-indexes</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># The following can be used as easy to replay backup logs or </span>
</span><span class='line'><span class="c"># for replication.</span>
</span><span class='line'><span class="c"># note: if you are setting up a replication slave, see </span>
</span><span class='line'><span class="c">#       README.Debian about other settings you may need </span>
</span><span class='line'><span class="c">#       to change.</span>
</span><span class='line'><span class="c">#server-id          = 1</span>
</span><span class='line'><span class="c">#log_bin            = /var/log/mysql/mysql-bin.log</span>
</span><span class='line'><span class="err">expire_logs_</span><span class="nb">days</span>    = <span class="m">10</span>
</span><span class='line'><span class="err">max_binlog_</span><span class="nb">size</span>     = <span class="m">100</span>M
</span><span class='line'><span class="c">#binlog_do_db       = include_database_name</span>
</span><span class='line'><span class="c">#binlog_ignore_db   = include_database_name</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># * InnoDB</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># InnoDB is enabled by default with a 10MB datafile in /var/lib/mysql/.</span>
</span><span class='line'><span class="c"># Read the manual for more InnoDB related options. There are many!</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># * Security Features</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Read the manual, too, if you want chroot!</span>
</span><span class='line'><span class="c"># chroot = /var/lib/mysql/</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># For generating SSL certificates I recommend the OpenSSL GUI &quot;tinyca&quot;.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># ssl-ca=/etc/mysql/cacert.pem</span>
</span><span class='line'><span class="c"># ssl-cert=/etc/mysql/server-cert.pem</span>
</span><span class='line'><span class="c"># ssl-key=/etc/mysql/server-key.pem</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Query Caching</span>
</span><span class='line'><span class="err">query-cache-</span><span class="nb">type</span> = <span class="m">1</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Default to InnoDB</span>
</span><span class='line'><span class="err">default-storage-engine=</span><span class="nb">innodb</span>
</span><span class='line'>
</span><span class='line'>[mysqldump]
</span><span class='line'><span class="nb">quick</span>
</span><span class='line'>quote-names
</span><span class='line'><span class="err">max_allowed_</span><span class="nb">packet</span>  = <span class="m">16</span>M
</span><span class='line'>
</span><span class='line'><span class="err">[mysql]</span>
</span><span class='line'><span class="c">#no-auto-rehash # faster start of mysql but no tab completition</span>
</span><span class='line'>
</span><span class='line'><span class="err">[isamchk]</span>
</span><span class='line'><span class="err">key_</span><span class="nb">buffer</span>      = <span class="m">16</span>M
</span></code></pre></td></tr></table></div></figure>


<h3>错误日志</h3>

<p>错误日志默认会存在数据目录下，也就是上面所定义的 <code>/usr/local/var/mysql/</code>，如果 Mac 电脑名字是 MacBook，那日志的全路径就是 <code>/usr/local/var/mysql/MacBook.local.err</code></p>

<h3>让别的电脑访问数据库</h3>

<p>取消下面两个文件中关于绑定 127.0.0.1 的语句<br/>
/etc/my.cnf</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">bind</span>-address <span class="o">=</span> 127.0.0.1
</span></code></pre></td></tr></table></div></figure>


<p>~/Library/LaunchAgents/homebrew.mxcl.mysql.plist</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;string&gt;</span>--bind-address=127.0.0.1<span class="nt">&lt;/string&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>就我个人而言，不需要 MySQL 自启动，所以只要在 <code>/etc/my.cnf</code> 改一下就好了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Use FFmpeg to burn subtitles into the video]]></title>
    <link href="http://ZPVIP.github.io/posts/2013/10/06/use-ffmpeg-to-burn-subtitles-into-the-video/"/>
    <updated>2013-10-06T12:41:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2013/10/06/use-ffmpeg-to-burn-subtitles-into-the-video</id>
    <content type="html"><![CDATA[<p><a href="http://www.ffmpeg.org/">FFmpeg</a> 是个强大的跨平台软件，在Mac下使用的时候要稍注意一下。我这记录一下自己的摸索过程。</p>

<p>我想在一个 MP4 文件里面添加字幕，不是把 .srt 字幕文件集成到 MP4 文件里，然后在播放器里选择字幕，这种集成字幕比较简单，速度也相当快：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ffmpeg -i input.mp4 -i subtitles.srt -c:s mov_text -c:v copy -c:a copy output.mp4
</span></code></pre></td></tr></table></div></figure>


<p>我希望字幕直接显示出来，其实也不难，两句命令而已：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ffmpeg -i subtitle.srt subtitle.ass
</span><span class='line'>ffmpeg -i input.mp4 -vf <span class="nv">ass</span><span class="o">=</span>subtitle.ass output.mp4
</span></code></pre></td></tr></table></div></figure>


<p>但在 Mac 下处理不成功，我看到有错误信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Fontconfig error: Cannot load default config file
</span><span class='line'><span class="o">[</span>Parsed_ass_0 @ 0x102d00000<span class="o">]</span> No usable fontconfig configuration file found, using fallback.
</span><span class='line'>Fontconfig error: Cannot load default config file
</span></code></pre></td></tr></table></div></figure>


<p>看来是 Fontconfig 出了问题，我的解决方案是：</p>

<p>一、在~/.bashrc 最后添加一句：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">FONTCONFIG_PATH</span><span class="o">=</span>/opt/X11/lib/X11/fontconfig
</span></code></pre></td></tr></table></div></figure>


<p>使之有效：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">source</span> ~/.bashrc
</span></code></pre></td></tr></table></div></figure>


<p>二、编辑 /opt/X11/lib/X11/fontconfig/fonts.conf
在字体目录添加 /Library/Fonts</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>:
</span><span class='line'><span class="c">&lt;!-- Font directory list --&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;dir&gt;</span>/opt/X11/share/fonts<span class="nt">&lt;/dir&gt;</span>
</span><span class='line'>  <span class="nt">&lt;dir&gt;</span>/usr/X11R6/lib/X11/fonts<span class="nt">&lt;/dir&gt;</span>
</span><span class='line'>  <span class="nt">&lt;dir&gt;</span>~/.fonts<span class="nt">&lt;/dir&gt;</span>
</span><span class='line'>  <span class="nt">&lt;dir&gt;</span>/Library/Fonts<span class="nt">&lt;/dir&gt;</span>
</span><span class='line'>:
</span></code></pre></td></tr></table></div></figure>


<p>再次运行添加 ass 字幕的命令就可以了，简单吧。市面上那么多视频处理软件，我估计都是FFmpeg加了个UI而已，如果命令行用得好，效率会高很多的。</p>

<p>更多 fontconfig 的信息可以参考<a href="http://www.freedesktop.org/software/fontconfig/fontconfig-user.html">这里</a>。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby -- block Proc and lambda]]></title>
    <link href="http://ZPVIP.github.io/posts/2013/02/17/ruby-block-proc-and-lambda/"/>
    <updated>2013-02-17T20:05:00+01:00</updated>
    <id>http://ZPVIP.github.io/posts/2013/02/17/ruby-block-proc-and-lambda</id>
    <content type="html"><![CDATA[<p>Block是Ruby中相当sexy的特性。对于常年在C/C++中Coding的码农来说，不管是表达方式还是思考方式都有点让人感觉不适应。
Block是一个统称，中文名称又叫闭包，英文是Closure，表现形式有block, Proc and lambda。Proc是对block的面向对象的封装， lambda是对Proc的进一步封装。</p>

<h1>block</h1>

<p>虽然Ruby中万物皆对象，但block是作为一个特性而存在，不是对象。也许很多Rails程序员还没看Ruby语法就已经用scaffold写Blog了，对别人程序中的一些代码连蒙带猜也很看得差不多懂，就比如下面的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">my_array</span> <span class="o">=</span> <span class="o">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="o">]</span>
</span><span class='line'><span class="n">my_array</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">number</span> <span class="o">|</span> <span class="nb">puts</span> <span class="n">number</span><span class="p">}</span>
</span><span class='line'><span class="n">my_array</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">number</span> <span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">number</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">my_array</span><span class="o">.</span><span class="n">each_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">index</span> <span class="o">|</span> <span class="nb">puts</span> <span class="s2">&quot;number has </span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>简单来说，<code>each</code>后面的几种表达就是<code>block</code>，上面的例子就是调用<code>Array</code>对象的<code>block</code>方法。看起来好像很神秘，其实我们也可以为自己的类定义一个block方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyArray</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:my_arr</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span> <span class="n">my_arr</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@my_arr</span> <span class="o">=</span> <span class="n">my_arr</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">my_each</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">my_block</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="vi">@my_arr</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span>
</span><span class='line'>      <span class="n">my_block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span> <span class="vi">@my_arr</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="no">MyArray</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="o">]</span> <span class="p">)</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">my_each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">number</span> <span class="o">|</span> <span class="nb">puts</span> <span class="n">number</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>结果很简单</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span>
</span><span class='line'><span class="mi">2</span>
</span><span class='line'><span class="mi">3</span>
</span><span class='line'><span class="mi">4</span>
</span></code></pre></td></tr></table></div></figure>


<p>之所以很多变量和方法都加个<code>my</code>前缀，是因为我想告诉大家这都是自定义的，是不是很帅？哦，不好意思，是不是很sexy？</p>

<p>既然已经说到自定义了，不能这样就结束了，我们可以再复杂一点：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyArray</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:my_arr</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span> <span class="n">my_arr</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@my_arr</span> <span class="o">=</span> <span class="n">my_arr</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">my_each</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">my_block</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="vi">@my_arr</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span>
</span><span class='line'>      <span class="n">my_block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span> <span class="vi">@my_arr</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="no">MyArray</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="o">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">my_each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">number</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span> <span class="nb">puts</span> <span class="s2">&quot;number at </span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2"> has value </span><span class="si">#{</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>结果如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">number</span> <span class="n">at</span> <span class="mi">0</span> <span class="n">has</span> <span class="n">value</span> <span class="mi">1</span>
</span><span class='line'><span class="n">number</span> <span class="n">at</span> <span class="mi">1</span> <span class="n">has</span> <span class="n">value</span> <span class="mi">2</span>
</span><span class='line'><span class="n">number</span> <span class="n">at</span> <span class="mi">2</span> <span class="n">has</span> <span class="n">value</span> <span class="mi">3</span>
</span><span class='line'><span class="n">number</span> <span class="n">at</span> <span class="mi">3</span> <span class="n">has</span> <span class="n">value</span> <span class="mi">4</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来不得不说一下<code>yield</code>这个关键字，我们从简单的例子开始：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyArray</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:my_arr</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span> <span class="n">my_arr</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@my_arr</span> <span class="o">=</span> <span class="n">my_arr</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">my_yield</span>
</span><span class='line'>    <span class="k">yield</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="no">MyArray</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="o">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">my_yield</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;yield is also sexy!&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>请大家无视1,2,3,4, 上面的例子只会输出<code>yield is also sexy!</code>, 也就是说 <code>a.my_yield</code> 后面的所有内容都跑到 <code>my_yield</code> 中，替换了 <code>yield</code>，简单吧。</p>

<p>下面开始对其升级：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyArray</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:my_arr</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span> <span class="n">my_arr</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@my_arr</span> <span class="o">=</span> <span class="n">my_arr</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">my_yield</span>
</span><span class='line'>    <span class="k">yield</span><span class="p">(</span> <span class="vi">@my_arr</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="no">MyArray</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="o">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">my_yield</span> <span class="p">{</span><span class="o">|</span> <span class="n">my_tmp_arr</span> <span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;yield with parameter!&quot;</span>
</span><span class='line'>  <span class="n">my_tmp_arr</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span> <span class="n">number</span> <span class="o">|</span> <span class="nb">puts</span> <span class="n">number</span><span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>yield with parameter!
</span><span class='line'>1
</span><span class='line'>2
</span><span class='line'>3
</span><span class='line'>4
</span></code></pre></td></tr></table></div></figure>


<p>如果你不是高手，我相信你会回头再品一下代码的，这个<code>my_yield</code>中到底发生了什么事？其实也不难，按照上例中的，把<code>a.my_yield</code>后面的全部甩到<code>my_yield</code>中替换<code>yield</code>, 然后用<code>@my_arr</code>替换<code>my_tmp_arr</code>就可以了。</p>

<h1>Proc</h1>

<p>前面说到<code>Proc</code>是Ruby对<code>block</code>的面向对象的封装，简单来说，就是我自己定义一个可以多次重用的<code>block</code>。还是看个例子吧，比如我想计算一个长方形的面积：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rectangle_area</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span><span class="p">{</span> <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">|</span> <span class="nb">puts</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="p">}</span>
</span><span class='line'><span class="n">rectangle_area</span><span class="o">.</span><span class="n">call</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我的想固定长边，只输入宽度就好了，那我可以加入一个参数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">rectangle_area_with_length</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Proc</span><span class="o">.</span><span class="n">new</span><span class="p">{</span> <span class="o">|</span> <span class="n">width</span> <span class="o">|</span> <span class="n">width</span> <span class="o">*</span> <span class="n">length</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">area</span> <span class="o">=</span> <span class="n">rectangle_area_with_length</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span><span class='line'><span class="n">area</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="n">area</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span>
</span><span class='line'><span class="n">area</span><span class="o">.</span><span class="n">class</span> <span class="c1"># =&gt; Proc</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后两种call的方式都行，结果都是18。我啰嗦一句，Ruby语法是可以省略<code>return</code>的，所以上面函数的返回值是个<code>Proc</code>，Proc里面的<code>block</code>返回值是<code>width * length</code>，没了return，眼睛里的确清静了很多。</p>

<h1>lambda</h1>

<p><code>lambda</code>是Ruby的一个函数，用来创建<code>Proc</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">multiply_lambda_proc</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">|</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># and we can call as a normal Proc</span>
</span><span class='line'><span class="n">multiply_lambda_proc</span><span class="o">.</span><span class="n">call</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">)</span> <span class="c1"># return 12</span>
</span></code></pre></td></tr></table></div></figure>


<p>其与 Proc 主要有两个不同点：</p>

<p>第一，lambda 会检查参数，而 Proc 不会。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">multiply_lambda_proc</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">|</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="p">}</span>
</span><span class='line'><span class="n">multiply_proc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">|</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">multiply_lambda_proc</span><span class="o">.</span><span class="n">call</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">)</span> <span class="c1"># ArgumentError: wrong number of arguments (3 for 2)</span>
</span><span class='line'><span class="n">multiply_proc</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">)</span> <span class="c1"># return 12 as normal</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This last command&#39;s error shows that Proc auto assigns missing argument with nil</span>
</span><span class='line'><span class="n">multiply_proc</span><span class="p">(</span> <span class="mi">3</span> <span class="p">)</span>  <span class="c1"># TypeError: nil can&#39;t be coerced into Fixnum</span>
</span></code></pre></td></tr></table></div></figure>


<p>第二，lambda 会返回它的调用函数，但 Proc 会结束它所位于的 function。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">return_from_proc</span>
</span><span class='line'>  <span class="n">ruby_proc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;return from a Proc&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">ruby_proc</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>  <span class="k">return</span> <span class="s2">&quot;The function will NOT reach here because a Proc containing a return statement has been called&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">return_from_lambda</span>
</span><span class='line'>  <span class="n">ruby_lambda</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;return from lambda&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">ruby_lambda</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>  <span class="k">return</span> <span class="s2">&quot;The function will reach here&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">return_from_proc</span> <span class="c1"># display return from proc</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">return_from_lambda</span> <span class="c1"># display The function will reach here</span>
</span></code></pre></td></tr></table></div></figure>


<p>参考：
<a href="http://railstalk.com/?p=28">RUBY BLOCK, PROC &amp; LAMBDA</a></p>

<p><a href="http://ruby-windy.iteye.com/blog/1197302">理解Ruby中block的本质</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mac OS X 10.8.2 Problems after update]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/10/18/mac-os-x-10-dot-8-2-problems-after-update/"/>
    <updated>2012-10-18T21:51:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/10/18/mac-os-x-10-dot-8-2-problems-after-update</id>
    <content type="html"><![CDATA[<p>Mac OS X 升级到10.8.2 以后，至少Retina Mac Pro 连接HDMI设备会出现问题，表现是笔记本和外接设备都黑屏，并且有个大大的鼠标，就像是分辨率变小了似的。</p>

<p>系统升级到OS X 10.8.2 (12C60)之后也没有改观。</p>

<p><a href="https://discussions.apple.com/thread/4312536?start=45&amp;tstart=0">Google之后</a>发现三步可以解决问题：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo rm /Library/Preferences/com.apple.windowserver.plist
</span><span class='line'>rm ~/Library/Preferences/ByHost/com.apple.windowserver.C751F3F4-AAAF-5E66-BDBF-91FD6960CC19.plist
</span><span class='line'>sudo shutdown -r now
</span></code></pre></td></tr></table></div></figure>


<p>第二步最后的文件名windowserver后面可能有点不一样，第三步是重启电脑，有打开的文件别忘记先存盘。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mac Octopress IOError invalid Python installation]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/08/02/mac-octopress-ioerror-invalid-python-installation/"/>
    <updated>2012-08-02T21:49:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/08/02/mac-octopress-ioerror-invalid-python-installation</id>
    <content type="html"><![CDATA[<p>经过这么多天的与Warning的邂逅，今天终于开云见日迎来了一个Error. 就在全国人民喜迎这个<code>IOError</code>之际，我三省吾身，不知道是因为升级了Mountain Lion 还是因为我最近折腾系统太厉害的缘故，好好的一个Octopress今天居然在<code>rake generate</code>的时候给我报错：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Building site: source -&gt; public
</span><span class='line'>Traceback (most recent call last):
</span><span class='line'>  File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site.py", line 565, in &lt;module&gt;
</span><span class='line'>  File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site.py", line 547, in main
</span><span class='line'>  File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site.py", line 278, in addusersitepackages
</span><span class='line'>  File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site.py", line 253, in getusersitepackages
</span><span class='line'>  File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site.py", line 243, in getuserbase
</span><span class='line'>  File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/sysconfig.py", line 523, in get_config_var
</span><span class='line'>  File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/sysconfig.py", line 419, in get_config_vars
</span><span class='line'>  File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/sysconfig.py", line 298, in _init_posix
</span><span class='line'>IOError: invalid Python installation: unable to open /usr/include/python2.7/pyconfig.h (No such file or directory)</span></code></pre></td></tr></table></div></figure>


<p>前面一堆文件都是在<code>/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/</code>，不知道为什么最后会找到这个文件夹去<code>/usr/include/python2.7/</code>。</p>

<p>这类找不到文件的问题在*nix下其实还是很好解决的，只要我能找到这个文件， 再把它<code>ln</code>过去就好了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mkdir /usr/include/
</span><span class='line'>$ sudo ln -s /System/Library/Frameworks/Python.framework/Versions/2.7/include/python2.7/ /usr/include/python2.7</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RStudio non-UTF8 warning message]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/08/02/rstudio-non-utf8-warning-message/"/>
    <updated>2012-08-02T20:06:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/08/02/rstudio-non-utf8-warning-message</id>
    <content type="html"><![CDATA[<p>Rstudio 是一个不错的R语言IDE, 因为集成<a href="http://yihui.name/knitr">knitr</a>, 使得这样一个编程IDE可以用Markdown来生成漂亮的PDF文本，甚至可以用LaTEX的语法加入公式，这样小篇幅的科技短文都可以用Markdown来写了。</p>

<p>我饶有兴致地安装了RStudio，结果一运行居然报了一个Warning，看来最近我的Warning不少。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>During startup - Warning messages: 
</span><span class='line'>1: Setting LC_CTYPE failed, using "C" 
</span><span class='line'>2: Setting LC_COLLATE failed, using "C" 
</span><span class='line'>3: Setting LC_TIME failed, using "C" 
</span><span class='line'>4: Setting LC_MESSAGES failed, using "C" 
</span><span class='line'>WARNING: You're using a non-UTF8 locale, therefore only ASCII 
</span><span class='line'>characters will work. 
</span><span class='line'>Please read R for Mac OS X FAQ (see Help) section 9 and adjust your 
</span><span class='line'>system preferences accordingly. </span></code></pre></td></tr></table></div></figure>


<p>解决的方法也就一句话，放在R控制台运行一下就好了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>system("defaults write org.R-project.R force.LANG en_US.UTF-8")</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PDF version found 1.5 but allowed 1.4]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/08/01/pdf-version-found-1-dot-5-but-allowed-1-dot-4/"/>
    <updated>2012-08-01T09:47:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/08/01/pdf-version-found-1-dot-5-but-allowed-1-dot-4</id>
    <content type="html"><![CDATA[<p>用Latex的时候，如果嵌入的PDF图片版本是1.5，而Latex只支持1.4的时候，就会出现很多Warning：</p>

<p><code>
 pdflatex (file ./graphics/abcde.pdf): PDF inclusion: found PDF version &lt;1.5&gt;, but at most version &lt;1.4&gt; allowed...
</code></p>

<p>Warning只是不好看，PDF还是会正确生成的，我不愿像传说中的程序员那样不关心Warning，但也无力把PDF图片改成1.4的版本，只好用sed大法了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>graphics
</span><span class='line'><span class="nv">$ </span><span class="k">for </span>i in *.pdf; <span class="k">do </span>sed -i -e  <span class="s2">&quot;s/%PDF-1.5/%PDF-1.4/&quot;</span> <span class="nv">$i</span>; <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>附上那个老掉牙的程序员笑话吧:</p>

<blockquote><p>有一个小伙子在一个办公大楼的门口抽着烟，一个妇女路过他身边，并对他说，“你知道不知道这个东西会危害你的健康？我是说，你有没有注意到香烟盒上的那个警告（Warning）？” 小伙子说，“没事儿，我是一个程序员”。 那妇女说，“这又怎样？” 程序员说，“我们从来不关心Warning，只心关心Error。”</p></blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[fatal error: stdio.h file not found]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/07/21/fatal-error-stdio-dot-h-file-not-found/"/>
    <updated>2012-07-21T20:31:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/07/21/fatal-error-stdio-dot-h-file-not-found</id>
    <content type="html"><![CDATA[<p>OS X 10.7.3 安装XCode 4.3.1 之后，如果你也安装了命令行：
Preferences > Downloads > Components and click install on Command Line Tools</p>

<p>那再编译什么东西的时候，就有可能收到报错信息，比如我就是在bundle install的时候得到如下信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Installing rb-fsevent <span class="o">(</span>0.4.3.1<span class="o">)</span> with native extensions
</span><span class='line'>Gem::Installer::ExtensionBuildError: ERROR: Failed to build gem native extension.
</span><span class='line'>
</span><span class='line'>        /usr/local/rvm/rubies/ruby-1.9.3-p194/bin/ruby extconf.rb
</span><span class='line'>creating Makefile
</span><span class='line'><span class="nv">CFLAGS</span><span class="o">=</span><span class="s1">&#39;-isysroot /Developer/SDKs/MacOSX10.7.sdk -mmacosx-version-min=10.7 -mdynamic-no-pic -std=gnu99 -Os -pipe -Wmissing-prototypes -Wreturn-type -Wmissing-braces -Wparentheses -Wswitch -Wunused-function -Wunused-label -Wunused-parameter -Wunused-variable -Wunused-value -Wuninitialized -Wunknown-pragmas -Wshadow -Wfour-char-constants -Wsign-compare -Wnewline-eof -Wconversion -Wshorten-64-to-32 -Wglobal-constructors -pedantic&#39;</span> /usr/bin/clang -isysroot /Developer/SDKs/MacOSX10.7.sdk -mmacosx-version-min<span class="o">=</span>10.7 -mdynamic-no-pic -std<span class="o">=</span>gnu99 -dead_strip -framework CoreServices -o <span class="s1">&#39;/usr/local/rvm/gems/ruby-1.9.3-p194/gems/rb-fsevent-0.4.3.1/bin/fsevent_watch&#39;</span> fsevent/fsevent_watch.c
</span><span class='line'>fsevent/fsevent_watch.c:1:10: fatal error: <span class="s1">&#39;stdio.h&#39;</span> file not found
</span><span class='line'><span class="c">#include &lt;stdio.h&gt;</span>
</span><span class='line'>         ^
</span><span class='line'>1 error generated.
</span><span class='line'>extconf.rb:59:in <span class="sb">`</span>&lt;main&gt;<span class="s1">&#39;: Compilation of fsevent_watch failed (see README) (RuntimeError)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="s1">Gem files will remain installed in /usr/local/rvm/gems/ruby-1.9.3-p194/gems/rb-fsevent-0.4.3.1 for inspection.</span>
</span><span class='line'><span class="s1">Results logged to /usr/local/rvm/gems/ruby-1.9.3-p194/gems/rb-fsevent-0.4.3.1/ext/gem_make.out</span>
</span><span class='line'><span class="s1">An error occured while installing rb-fsevent (0.4.3.1), and Bundler cannot continue.</span>
</span><span class='line'><span class="s1">Make sure that `gem install rb-fsevent -v &#39;</span>0.4.3.1<span class="err">&#39;</span><span class="sb">`</span> succeeds before bundling.
</span></code></pre></td></tr></table></div></figure>


<p>如果用心看一下，报的是<code>stdio.h file not found</code>.</p>

<p>其实问题出在这个command line tools上，可以用下面这个命令修正：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MongoDB Scaffolding Devise Omniauth CanCan (2)]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/06/06/mongodb-scaffolding-devise-omniauth-cancan-2/"/>
    <updated>2012-06-06T22:26:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/06/06/mongodb-scaffolding-devise-omniauth-cancan-2</id>
    <content type="html"><![CDATA[<p><a id="TOP0606"></a>
1. <a href="#Devise">Devise</a><br/>
2. <a href="#Omniauth">Omniauth</a><br/>
3. <a href="#CanCan">CanCan</a></p>

<h2><a id="Devise"></a><a href="#TOP">Devise</a></h2>

<p>现在安装Devise, 和使用其它数据库一样, 首先在Gemfile加入devise, 然后安装Devise:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi Gemfile
</span><span class='line'>...
</span><span class='line'>gem <span class="s1">&#39;devise&#39;</span>,<span class="s1">&#39;2.1.0&#39;</span>
</span><span class='line'>...
</span><span class='line'><span class="nv">$ </span>bundle install
</span><span class='line'>      create  config/initializers/devise.rb
</span><span class='line'>      create  config/locales/devise.en.yml
</span><span class='line'><span class="o">===============================================================================</span>
</span><span class='line'>
</span><span class='line'>Some setup you must <span class="k">do </span>manually <span class="k">if </span>you haven<span class="s1">&#39;t yet:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  1. Ensure you have defined default url options in your environments files. Here</span>
</span><span class='line'><span class="s1">     is an example of default_url_options appropriate for a development environment</span>
</span><span class='line'><span class="s1">     in config/environments/development.rb:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">       config.action_mailer.default_url_options = { :host =&gt; &#39;</span>localhost:3000<span class="err">&#39;</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>     In production, :host should be <span class="nb">set </span>to the actual host of your application.
</span><span class='line'>
</span><span class='line'>  2. Ensure you have defined root_url to *something* in your config/routes.rb.
</span><span class='line'>     For example:
</span><span class='line'>
</span><span class='line'>       root :to <span class="o">=</span>&gt; <span class="s2">&quot;home#index&quot;</span>
</span><span class='line'>
</span><span class='line'>  3. Ensure you have flash messages in app/views/layouts/application.html.erb.
</span><span class='line'>     For example:
</span><span class='line'>
</span><span class='line'>       &lt;p <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;notice&quot;</span>&gt;&lt;%<span class="o">=</span> notice %&gt;&lt;/p&gt;
</span><span class='line'>       &lt;p <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span>&gt;&lt;%<span class="o">=</span> alert %&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>  4. If you are deploying Rails 3.1 on Heroku, you may want to <span class="nb">set</span>:
</span><span class='line'>
</span><span class='line'>       config.assets.initialize_on_precompile <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>
</span><span class='line'><span class="nb">     </span>On config/application.rb forcing your application to not access the DB
</span><span class='line'>     or load models when precompiling your assets.
</span><span class='line'>
</span><span class='line'><span class="o">===============================================================================</span>
</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<p>Devise会知道我们已经安装了Mongoid, 所以它会在<code>config/initializers/devise.rb</code>中加入ORM的支持:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;devise/orm/mongoid&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面建立User model</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails generate devise User
</span><span class='line'>      invoke  mongoid
</span><span class='line'>      create    app/models/user.rb
</span><span class='line'>      insert    app/models/user.rb
</span><span class='line'>      insert    app/models/user.rb
</span><span class='line'>       route  devise_for :users
</span></code></pre></td></tr></table></div></figure>


<p>Devise做的工作在上面已经表现得很清楚了, 一方面在route中增加了<code>devise_for :users</code>，另一方面生成User Model，我们可以在<code>app/models/user.rb</code>中看到Devise已经使用Mongoid了:</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="c1"># Include default devise modules. Others available are:</span>
</span><span class='line'>  <span class="c1"># :token_authenticatable, :confirmable,</span>
</span><span class='line'>  <span class="c1"># :lockable, :timeoutable and :omniauthable</span>
</span><span class='line'>  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Database authenticatable</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span>              <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:encrypted_password</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Recoverable</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:reset_password_token</span><span class="p">,</span>   <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:reset_password_sent_at</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Time</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Rememberable</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:remember_created_at</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Time</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Trackable</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:sign_in_count</span><span class="p">,</span>      <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:current_sign_in_at</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Time</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:last_sign_in_at</span><span class="p">,</span>    <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Time</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:current_sign_in_ip</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:last_sign_in_ip</span><span class="p">,</span>    <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Confirmable</span>
</span><span class='line'>  <span class="c1"># field :confirmation_token,   :type =&gt; String</span>
</span><span class='line'>  <span class="c1"># field :confirmed_at,         :type =&gt; Time</span>
</span><span class='line'>  <span class="c1"># field :confirmation_sent_at, :type =&gt; Time</span>
</span><span class='line'>  <span class="c1"># field :unconfirmed_email,    :type =&gt; String # Only if using reconfirmable</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Lockable</span>
</span><span class='line'>  <span class="c1"># field :failed_attempts, :type =&gt; Integer, :default =&gt; 0 # Only if lock strategy is :failed_attempts</span>
</span><span class='line'>  <span class="c1"># field :unlock_token,    :type =&gt; String # Only if unlock strategy is :email or :both</span>
</span><span class='line'>  <span class="c1"># field :locked_at,       :type =&gt; Time</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Token authenticatable</span>
</span><span class='line'>  <span class="c1"># field :authentication_token, :type =&gt; String</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Devise由12个Modules组成， 在上面的注释中就有体现， 下面我大致翻译一下各个Module的功用( <a href="https://github.com/plataformatec/devise">原文可以去看官方文档</a> )：</p>

<ol>
<li>Database Authenticatable: 用户验证和登录过程中, 把用户的密码加密然后把加密后的密码存在数据库中。</li>
<li>Token Authenticatable: 基于验证令牌的用户登录方法。</li>
<li>Omniauthable: 添加Omniauth支持。</li>
<li>Confirmable: 通过发E-Mail的方式验证用户帐号是否通过通过认证。</li>
<li>Recoverable: 通过发E-Mail的方式支持用户找回密码。</li>
<li>Registerable: 处理用户注册过程,也可以让他们编辑和销毁他们的帐户。</li>
<li>Rememberable: 通过Cookie来记住用户。</li>
<li>Trackable: 跟踪用户的登录次数、时间和IP地址。</li>
<li>Timeoutable: 假如用户一段时间没有活动， 自动用户处于不登录状态。</li>
<li>Validatable: 用户通过E-Mail和密码登录， 可以自定义，比如使用用户名和密码登录。</li>
<li>Lockable: 几次失败的登录尝试后，锁定用户， 可以在一段时间后通过E-Mail解锁。</li>
<li>Encryptable: 除了内置的Bcrypt(默认)，增加支持认证机制。</li>
</ol>


<p>用E-Mail登录可能不是所有网站都想要的风格，如果想要用用户名登录，我们就可以加一个字段，就像上一篇所说的，如果用MySql或Sqlite之类的，还要<code>rake migrate</code>，但现在，只要添加这个字段就好了：</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">field</span> <span class="ss">:user_name</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>用户表中有很多字段，我们希望在用户登录之前只有少量字段可以用来验证真实用户，所以<code>attr_accessible</code>就只包括用户名、邮件、密码和“记住我”，除此之外，用户名和邮件地址唯一性可以通过<code>validates_uniqueness_of</code>保障。</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_presence_of</span> <span class="ss">:user_name</span>
</span><span class='line'><span class="n">validates_uniqueness_of</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:case_sensitive</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'><span class="n">attr_accessible</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">:remember_me</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们在User Model里面使用了Registerable, 这样我们就可以Devise来生成注册的Views：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">generate</span> <span class="n">devise</span><span class="ss">:views</span>
</span><span class='line'>      <span class="n">invoke</span>  <span class="no">Devise</span><span class="o">::</span><span class="no">Generators</span><span class="o">::</span><span class="no">SharedViewsGenerator</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">shared</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">_links</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">invoke</span>  <span class="n">form_for</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">confirmations</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">confirmations</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">passwords</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">passwords</span><span class="o">/</span><span class="n">edit</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">passwords</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">registrations</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">registrations</span><span class="o">/</span><span class="n">edit</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">registrations</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">sessions</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">sessions</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">unlocks</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">unlocks</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">invoke</span>  <span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">mailer</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">mailer</span><span class="o">/</span><span class="n">confirmation_instructions</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">mailer</span><span class="o">/</span><span class="n">reset_password_instructions</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">mailer</span><span class="o">/</span><span class="n">unlock_instructions</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为我们添加了user_name字段，所以相应地要在Views里面添加这个输入框：</p>

<figure class='code'><figcaption><span>app/views/devise/registrations/edit.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">...</span>
</span><span class='line'><span class="x">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;br /&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;/div&gt;</span>
</span><span class='line'><span class="x">...</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/views/devise/registrations/new.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">...</span>
</span><span class='line'><span class="x">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;br /&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;/div&gt;</span>
</span><span class='line'><span class="x">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为Devise已经集成了创建、编辑和删除用户的Controller，所以我们不用在自己的项目中添加任何代码。</p>

<p>为了在项目首页添加用户注册相关的链接，下面修改首页代码：
首先确定一下哪个是首页</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">root</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;articles#index&#39;</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后再修改相应的View</p>

<figure class='code'><figcaption><span>app/views/articles/index.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div id=&quot;user_nav&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">user_signed_in?</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    Signed in as &lt;strong&gt;</span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;/strong&gt;. Not you?</span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">destroy_user_session_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up&quot;</span><span class="p">,</span> <span class="n">new_user_registration_path</span> <span class="cp">%&gt;</span><span class="x"> or</span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">new_user_session_path</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>把以下代码加入<code>app/views/layouts/application.html.erb</code>的<code>&lt;body&gt;</code>下方</p>

<figure class='code'><figcaption><span>app/views/layouts/application.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;p class=&quot;notice&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="n">notice</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span><span class='line'><span class="x">&lt;p class=&quot;alert&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="n">alert</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>到现在为止，Devise就可以正常动作了。如果还需要用户管理界面之类的，那就请大家自己接着开发吧。</p>

<h2><a id="Omniauth"></a><a href="#TOP">Omniauth</a></h2>

<p>下面继续为项目添加Omniauth。主要参考<a href="https://github.com/plataformatec/devise/wiki/OmniAuth:-Overview">Omniauth-facebook</a>。</p>

<p>首先添加Omniauth到Gemfile，别忘了<code>$ bundle install</code>:</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;omniauth&quot;</span><span class="p">,</span> <span class="s1">&#39;1.1.0&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;omniauth-facebook&quot;</span><span class="p">,</span> <span class="s1">&#39;1.3.0&#39;</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在Devise的初始化文件中定义facebook的一些参数：</p>

<figure class='code'><figcaption><span>config/initializers/devise.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="c1"># ==&gt; OmniAuth</span>
</span><span class='line'><span class="c1"># Add a new OmniAuth provider. Check the wiki for more information on setting</span>
</span><span class='line'><span class="c1"># up on your models and hooks.</span>
</span><span class='line'><span class="c1"># config.omniauth :github, &#39;APP_ID&#39;, &#39;APP_SECRET&#39;, :scope =&gt; &#39;user,public_repo&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;omniauth-facebook&quot;</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="s2">&quot;APP_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;APP_SECRET&quot;</span><span class="p">,</span> <span class="ss">:strategy_class</span> <span class="o">=&gt;</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Strategies</span><span class="o">::</span><span class="no">Facebook</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中&#8221;APP_ID&#8221;和&#8221;APP_SECRET&#8221;要去<a href="https://developers.facebook.com/apps/">Facebook</a>去申请。如果是本地测试，可以把Site URL设为http://localhost:3000/, Site Domain可设为localhost。</p>

<p>Devise 12个Modules之一的:omniauthable要从注释中解放出来了：</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">devise</span> <span class="ss">:omniauthable</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在Devise已经在User Model中加入了两个方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user_omniauth_authorize_path</span><span class="p">(</span><span class="ss">:facebook</span><span class="p">)</span>
</span><span class='line'><span class="n">user_omniauth_callback_path</span><span class="p">(</span><span class="ss">:facebook</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来把<code>Sign in with Facebook</code>的链接加到<code>Sign up</code>和<code>Sign in</code>的后面，这样点击这个链接就会把用户带到Facebook，如果用户成功登录Facebook，那Fackbook会把用户信息返回给开始设定好的Callback方法。</p>

<figure class='code'><figcaption><span>cat app/views/articles/index.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div id=&quot;user_nav&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">user_signed_in?</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  Signed in as &lt;strong&gt;</span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;/strong&gt;. Not you?</span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">destroy_user_session_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up&quot;</span><span class="p">,</span> <span class="n">new_user_registration_path</span> <span class="cp">%&gt;</span><span class="x"> or</span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">new_user_session_path</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in with Facebook&quot;</span><span class="p">,</span> <span class="n">user_omniauth_authorize_path</span><span class="p">(</span><span class="ss">:facebook</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Callback的方法在<code>config/routes.rb</code>中定义：</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:omniauth_callbacks</span> <span class="o">=&gt;</span> <span class="s2">&quot;users/omniauth_callbacks&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>既然定义了Callback是<code>users/omniauth_callbacks</code>，那就要建立相应的文件：</p>

<figure class='code'><figcaption><span>app/controllers/users/omniauth_callbacks_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Users</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">facebook</span>
</span><span class='line'>    <span class="c1"># You need to implement the method below in your model</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_for_facebook_oauth</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">persisted?</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span> <span class="s2">&quot;devise.omniauth_callbacks.success&quot;</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="s2">&quot;Facebook&quot;</span>
</span><span class='line'>      <span class="n">sign_in_and_redirect</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:event</span> <span class="o">=&gt;</span> <span class="ss">:authentication</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="s2">&quot;devise.facebook_data&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">new_user_registration_url</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>从代码中不难发现，所有从Facebook中传来的信息都存在request.env[&#8220;omniauth.auth&#8221;], 从服务器日志来看，具体信息如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;Hashie::Mash</span> <span class="na">email=</span><span class="s">&quot;zhangsan@gmail.com&quot;</span>
</span><span class='line'><span class="na">first_name=</span><span class="s">&quot;三&quot;</span>
</span><span class='line'><span class="na">gender=</span><span class="s">&quot;male&quot;</span>
</span><span class='line'><span class="na">id=</span><span class="s">&quot;100000531508888&quot;</span>
</span><span class='line'><span class="na">last_name=</span><span class="s">&quot;张&quot;</span>
</span><span class='line'><span class="na">link=</span><span class="s">&quot;http://www.facebook.com/profile.php?id=100000531508888&quot;</span>
</span><span class='line'><span class="na">locale=</span><span class="s">&quot;zh_CN&quot;</span>
</span><span class='line'><span class="na">name=</span><span class="s">&quot;张三&quot;</span>
</span><span class='line'><span class="na">timezone=</span><span class="s">2</span>
</span><span class='line'><span class="na">updated_time=</span><span class="s">&quot;2011-06-01T20:26:05+0000&quot;</span>
</span><span class='line'><span class="na">verified=</span><span class="s">true</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面这个Controller中的<code>find_for_facebook_oauth</code>还没有定义呢，把下面的代码添加到User Model里面吧：</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>    <span class="n">where</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_facebook_oauth</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">signed_in_resource</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">access_token</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>      <span class="n">user</span>
</span><span class='line'>    <span class="k">else</span> <span class="c1"># Create a user with a stub password.</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="no">Devise</span><span class="o">.</span><span class="n">friendly_token</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_with_session</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">data</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="s2">&quot;devise.facebook_data&quot;</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">session</span><span class="o">[</span><span class="s2">&quot;devise.facebook_data&quot;</span><span class="o">][</span><span class="s2">&quot;extra&quot;</span><span class="o">][</span><span class="s2">&quot;raw_info&quot;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>好了，重启Web服务，测试一下用Facebook登录吧。</p>

<h2><a id="CanCan"></a><a href="#TOP">CanCan</a></h2>

<p>现在进入最后一个主题<a href="https://github.com/ryanb/cancan">CanCan</a>，也就是权限系统。
第一件事照旧就是Gemfile和<code>$ bundle install</code>，CanCan从版本1.5开始就支持Mongoid了，但在Gemfile中要在CanCan之前包含Mongoid。</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;mongoid&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.4&quot;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;cancan&#39;</span><span class="p">,</span><span class="s1">&#39;1.6.7&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后生成ability.rb文件。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails g cancan:ability
</span><span class='line'>      create  app/models/ability.rb
</span></code></pre></td></tr></table></div></figure>


<p>接下来参考这篇<a href="https://github.com/ryanb/cancan/wiki/Role-Based-Authorization">文章</a>，在User Model中添加一个字段<code>roles_mask</code>, 然后把用户角色的定义加入User Model。</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">field</span> <span class="ss">:roles_mask</span>
</span><span class='line'><span class="no">ROLES</span> <span class="o">=</span> <span class="sx">%w[admin moderator author]</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面的代码是为了给用户getting 和 setting角色的</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">roles</span><span class="o">=</span><span class="p">(</span><span class="n">roles</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">roles_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">roles</span> <span class="o">&amp;</span> <span class="no">ROLES</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="mi">2</span><span class="o">**</span><span class="no">ROLES</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">sum</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">roles</span>
</span><span class='line'>  <span class="no">ROLES</span><span class="o">.</span><span class="n">reject</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>    <span class="p">((</span><span class="n">roles_mask</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="o">**</span><span class="no">ROLES</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">role?</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
</span><span class='line'>  <span class="n">roles</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为项目集成了Devise，所以要把roles这个属性设置为accessible</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">attr_accessible</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">:roles</span>
</span></code></pre></td></tr></table></div></figure>


<p>application.html.erb 中可以加上如下代码，可以用来检查current_user</p>

<figure class='code'><figcaption><span>app/views/layouts/application.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">br</span><span class="sr"> /&gt;</span>
</span><span class='line'><span class="sr">&lt;% if current_user != nil %&gt;</span>
</span><span class='line'><span class="sr">user:&lt;%= current_user.user_name %&gt;&lt;br /</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">user_id</span><span class="p">:</span><span class="o">&lt;</span><span class="sx">%= current_user.id %&gt;&lt;br /&gt;</span>
</span><span class='line'><span class="sx">user_role:&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">roles_mask</span> <span class="sx">%&gt;&lt;br /&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% else %&gt;</span>
</span><span class='line'><span class="sx">&lt;%= &quot;nil user&quot; %&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为前面Article Model没有和User Model里面的user_name联系起来，所以只能用Article里面<code>引用关联 Reference Type Associations</code>的Author Model中的<code>author_id</code>和User Model的<code>user_name</code>比较，如果一样，就让用户可以编辑文章。这只是个CanCan示例，真用起来千万别这么干。</p>

<figure class='code'><figcaption><span>app/models/ability.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Ability</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="c1"># guest user (not logged in)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role?</span> <span class="ss">:admin</span>
</span><span class='line'>      <span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="ss">:all</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="ss">:all</span>
</span><span class='line'>      <span class="n">can</span> <span class="ss">:create</span><span class="p">,</span> <span class="no">Comment</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role?</span><span class="p">(</span><span class="ss">:author</span><span class="p">)</span>
</span><span class='line'>        <span class="n">can</span> <span class="ss">:create</span><span class="p">,</span> <span class="no">Article</span>
</span><span class='line'>        <span class="n">can</span> <span class="ss">:update</span><span class="p">,</span> <span class="no">Article</span> <span class="k">do</span> <span class="o">|</span><span class="n">article</span><span class="o">|</span>
</span><span class='line'>          <span class="n">article</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:author_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">user_name</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后在Article Controller加上一句就可以实现权限控制了</p>

<figure class='code'><figcaption><span>app/controllers/articles_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>   <span class="n">load_and_authorize_resource</span>
</span><span class='line'>   <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了版面好看，在view中加入权限控制也很简单</p>

<figure class='code'><figcaption><span>app/views/articles/index.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% if </span><span class="n">can?</span> <span class="ss">:update</span><span class="p">,</span> <span class="n">article</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;td&gt;</span><span class="o">&lt;</span><span class="sx">%= link_to &#39;Edit&#39;, edit_article_path(article) %&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="sx">&lt;% end %&gt;</span>
</span><span class='line'><span class="sx">&lt;% if can? :destroy, article %&gt;</span>
</span><span class='line'><span class="sx">  &lt;td&gt;&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Destroy&#39;</span><span class="p">,</span> <span class="n">article</span><span class="p">,</span> <span class="n">confirm</span><span class="p">:</span> <span class="s1">&#39;Are you sure?&#39;</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="sx">%&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>至此，这个练习的小站就建好了，比较@_@的是
首先要在http://localhost:3000/authors/ 添加一个用户名，比如neten
然后在http://localhost:3000/articles/new 添加文章的时候选择neten作为Author
最后注册一个Role为Author的用户neten, 这样，neten登录的时候，在http://localhost:3000/看到的文章列表中，他自己发的文章都可以Show，也可以Edit,但不可以destroy，如果用户是admin，那所有的链接都是有效的。</p>

<p>这两篇blog只是自己的学习记录，希望对大家有所帮助，如果设计真实项目还要精细思考一下。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MongoDB Scaffolding Devise Omniauth CanCan (1)]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/05/19/mongodb-scaffolding-devise-omniauth-cancan-1/"/>
    <updated>2012-05-19T22:42:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/05/19/mongodb-scaffolding-devise-omniauth-cancan-1</id>
    <content type="html"><![CDATA[<p><a id="TOP"></a>
Ruby on Rails 的学习曲线还算是有一点陡的, 作为一个初学者, 建议先看一下Ruby的语法书, 再看一下Rails的<a href="http://guides.rubyonrails.org">入门教材和示例</a>, 但真正做项目的时候, 可能就要和各种各样Gems打交道了, 因为自己走了很多弯路, 所以想把一些笔记分享出来, 希望对新生有点帮助.</p>

<p>我准备用一个Blog的示例把Scaffolding MongoDB Devise Omniauth CanCan串起来.</p>

<ol>
<li><a href="#MongoDB">MongoDB</a><br/>
1.1 <a href="#Help">Help</a><br/>
1.2. <a href="#CRUD">CRUD</a><br/>
1.3. <a href="#Security">Security</a><br/>
1.4. <a href="#Port">Port</a></li>
<li><a href="#Prepare">准备工作</a></li>
<li><a href="#Git">Git</a></li>
<li><a href="#Scaffold">Scaffold</a><br/>
4.1. <a href="#AddField">添加字段</a><br/>
4.2. <a href="#Validations">验证输入</a><br/>
4.3. <a href="#Associations">表关联</a><br/>
4.4. <a href="#ReferenceTypeAssociations">引用关联</a></li>
</ol>


<!-- more -->


<h2><a id="MongoDB"></a><a href="#TOP">MongoDB</a></h2>

<p>首先讲 <a href="http://www.mongodb.org/">MongoDB</a>, Mongo 取自 hu<strong>mongo</strong>us, 意思是大得无比的.</p>

<p>在Ubuntu上安装MongoDB相当简单. <a href="http://docs.mongodb.org/manual/tutorial/install-mongodb-on-debian-or-ubuntu-linux/">其网站上有详细资料</a>, 我仅copy一下几条命令:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-key adv --keyserver keyserver.ubuntu.com --recv 7F0CEB10
</span><span class='line'><span class="nv">$ </span>sudo vi /etc/apt/sources.list.d/10gen.list
</span><span class='line'>deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sudo apt-get update
</span><span class='line'><span class="nv">$ </span>sudo apt-get install mongodb-10gen
</span></code></pre></td></tr></table></div></figure>


<p>配置文件, 可以改变数据库存储目录等, 默认是 <code>/var/lib/mongodb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo vi /etc/mongodb.conf
</span></code></pre></td></tr></table></div></figure>


<p>数据库启动停用重启命令和其它service一样:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo service mongodb start | stop | restart
</span></code></pre></td></tr></table></div></figure>


<p>命令行输入<code>mongo</code>可以打开数据库操作台:</p>

<h3><a id="Help"></a><a href="#TOP">Help</a></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">help</span>                          <span class="o">//</span> <span class="c1">--top level help</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">help</span><span class="p">()</span>                     <span class="o">//</span> <span class="c1">--help on db-specific methods</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">mycollection</span><span class="p">.</span><span class="n">help</span><span class="p">()</span>        <span class="o">//</span> <span class="c1">--help on collection methods</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">mycollection</span><span class="p">.</span><span class="n">find</span><span class="p">().</span><span class="n">help</span><span class="p">()</span> <span class="o">//</span> <span class="c1">--cursor help</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="k">show</span> <span class="n">dbs</span> <span class="o">//</span> <span class="c1">--displays all the databases on the server you are connected to</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">use</span> <span class="n">db_name</span> <span class="o">//</span> <span class="c1">--switches to db_name on the same server</span>
</span><span class='line'><span class="o">&gt;</span> <span class="k">show</span> <span class="n">collections</span> <span class="o">//</span> <span class="c1">--displays a list of all the collections in the current database</span>
</span></code></pre></td></tr></table></div></figure>


<p>不能免俗, 可以在默认的<code>test</code>数据库来个<code>hello world!</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">save</span><span class="p">(</span> <span class="err">{</span> <span class="n">mongo</span><span class="p">:</span> <span class="ss">&quot;Hello World!&quot;</span> <span class="err">}</span> <span class="p">)</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">find</span><span class="p">()</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fb947a9e7ffc7b413ce9c54&quot;</span><span class="p">),</span> <span class="ss">&quot;mongo&quot;</span> <span class="p">:</span> <span class="ss">&quot;Hello World!&quot;</span> <span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a id="CRUD"></a><a href="#TOP">CRUD</a></h3>

<h4>C: create</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="err">{</span> <span class="n">website</span> <span class="p">:</span> <span class="ss">&quot;blog.neten.de&quot;</span><span class="err">}</span><span class="p">);</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="err">{</span> <span class="n">website</span> <span class="p">:</span> <span class="ss">&quot;bbs.neten.de&quot;</span><span class="err">}</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>R: read</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">find</span><span class="p">();</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fb947a9e7ffc7b413ce9c54&quot;</span><span class="p">),</span> <span class="ss">&quot;mongo&quot;</span> <span class="p">:</span> <span class="ss">&quot;Hello World!&quot;</span> <span class="err">}</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fb94971e7ffc7b413ce9c55&quot;</span><span class="p">),</span> <span class="ss">&quot;website&quot;</span> <span class="p">:</span> <span class="ss">&quot;blog.neten.de&quot;</span> <span class="err">}</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fb94978e7ffc7b413ce9c56&quot;</span><span class="p">),</span> <span class="ss">&quot;website&quot;</span> <span class="p">:</span> <span class="ss">&quot;bbs.neten.de&quot;</span> <span class="err">}</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">findOne</span><span class="p">(</span> <span class="err">{</span> <span class="n">mongo</span><span class="p">:</span> <span class="ss">&quot;Hello World!&quot;</span> <span class="err">}</span> <span class="p">);</span>
</span><span class='line'><span class="err">{</span>
</span><span class='line'>      <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fb947a9e7ffc7b413ce9c54&quot;</span><span class="p">),</span>
</span><span class='line'>      <span class="ss">&quot;mongo&quot;</span> <span class="p">:</span> <span class="ss">&quot;Hello World!&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">&quot;website&quot;</span> <span class="p">:</span> <span class="ss">&quot;www.neten.de&quot;</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>U: update</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">person</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">findOne</span><span class="p">(</span> <span class="err">{</span> <span class="n">mongo</span><span class="p">:</span> <span class="ss">&quot;Hello World!&quot;</span> <span class="err">}</span> <span class="p">);</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">person</span><span class="p">.</span><span class="n">website</span> <span class="o">=</span> <span class="ss">&quot;www.neten.de&quot;</span><span class="p">;</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">save</span><span class="p">(</span> <span class="n">person</span> <span class="p">);</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">find</span><span class="p">();</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fb94971e7ffc7b413ce9c55&quot;</span><span class="p">),</span> <span class="ss">&quot;website&quot;</span> <span class="p">:</span> <span class="ss">&quot;blog.neten.de&quot;</span> <span class="err">}</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fb94978e7ffc7b413ce9c56&quot;</span><span class="p">),</span> <span class="ss">&quot;website&quot;</span> <span class="p">:</span> <span class="ss">&quot;bbs.neten.de&quot;</span> <span class="err">}</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fb947a9e7ffc7b413ce9c54&quot;</span><span class="p">),</span> <span class="ss">&quot;mongo&quot;</span> <span class="p">:</span> <span class="ss">&quot;Hello World!&quot;</span><span class="p">,</span> <span class="ss">&quot;website&quot;</span> <span class="p">:</span> <span class="ss">&quot;www.neten.de&quot;</span> <span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>D: delete</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="k">drop</span><span class="p">()</span> <span class="o">//</span> <span class="c1">--drop the entire test collection</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">remove</span><span class="p">()</span> <span class="o">//</span> <span class="c1">--remove all objects from the collection</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span> <span class="err">{</span> <span class="n">mongo</span> <span class="p">:</span> <span class="ss">&quot;Hello World!&quot;</span> <span class="err">}</span> <span class="p">)</span> <span class="o">//</span> <span class="c1">--remove objects from the collection where name is mongo</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">use</span> <span class="p">[</span><span class="k">database</span><span class="p">];</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">dropDatabase</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果删除Collection之后, 可能要重启才能看到Collection不见了.</p>

<h3><a id="Security"></a><a href="#TOP">Security</a></h3>

<p>还有一个重要工作就是<a href="http://www.mongodb.org/display/DOCS/Security+and+Authentication">安全工作</a>:</p>

<p>添加管理员用户laoda(老大), 管理员的名字最好不要用admin, root之类的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">use</span> <span class="k">admin</span>
</span><span class='line'><span class="n">switched</span> <span class="k">to</span> <span class="n">db</span> <span class="k">admin</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">addUser</span><span class="p">(</span><span class="ss">&quot;laoda&quot;</span><span class="p">,</span><span class="ss">&quot;neten&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;n&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">&quot;connectionId&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">&quot;err&quot;</span> <span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="ss">&quot;ok&quot;</span> <span class="p">:</span> <span class="mi">1</span> <span class="err">}</span>
</span><span class='line'><span class="err">{</span>
</span><span class='line'>  <span class="ss">&quot;user&quot;</span> <span class="p">:</span> <span class="ss">&quot;laoda&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">&quot;readOnly&quot;</span> <span class="p">:</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">&quot;pwd&quot;</span> <span class="p">:</span> <span class="ss">&quot;3d075670621dfa6f25d9b6b9caa1d987&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fbb5c2c124f3221f45162b4&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>验证函数:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">auth</span><span class="p">(</span><span class="ss">&quot;laoda&quot;</span><span class="p">,</span><span class="ss">&quot;neten&quot;</span><span class="p">)</span>
</span><span class='line'><span class="mi">1</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">auth</span><span class="p">(</span><span class="ss">&quot;laoda&quot;</span><span class="p">,</span><span class="ss">&quot;neten.de&quot;</span><span class="p">)</span>
</span><span class='line'><span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>添加普通用户xiaodi(小弟)和只读用户(龙套):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">use</span> <span class="n">test</span>
</span><span class='line'><span class="n">switched</span> <span class="k">to</span> <span class="n">db</span> <span class="n">test</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">addUser</span><span class="p">(</span><span class="ss">&quot;xiaodi&quot;</span><span class="p">,</span><span class="ss">&quot;neten&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;n&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">&quot;connectionId&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">&quot;err&quot;</span> <span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="ss">&quot;ok&quot;</span> <span class="p">:</span> <span class="mi">1</span> <span class="err">}</span>
</span><span class='line'><span class="err">{</span>
</span><span class='line'>  <span class="ss">&quot;user&quot;</span> <span class="p">:</span> <span class="ss">&quot;xiaodi&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">&quot;readOnly&quot;</span> <span class="p">:</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">&quot;pwd&quot;</span> <span class="p">:</span> <span class="ss">&quot;8cb78b1a918c6c5cca2b9cea00673180&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fbb5c96124f3221f45162b5&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">}</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">addUser</span><span class="p">(</span><span class="ss">&quot;longtao&quot;</span><span class="p">,</span><span class="ss">&quot;neten&quot;</span><span class="p">,</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;n&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">&quot;connectionId&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">&quot;err&quot;</span> <span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="ss">&quot;ok&quot;</span> <span class="p">:</span> <span class="mi">1</span> <span class="err">}</span>
</span><span class='line'><span class="err">{</span>
</span><span class='line'>  <span class="ss">&quot;user&quot;</span> <span class="p">:</span> <span class="ss">&quot;longtao&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">&quot;readOnly&quot;</span> <span class="p">:</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">&quot;pwd&quot;</span> <span class="p">:</span> <span class="ss">&quot;fe130c893dd5c69a5a1cb96feba00f7d&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fbb5cc7124f3221f45162b6&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>虽然我取的密码都是neten, 但hash过后的字符串都不一样, 比md5靠谱.</p>

<p>查找当前数据库用户:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="k">system</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">find</span><span class="p">()</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fbb5c96124f3221f45162b5&quot;</span><span class="p">),</span> <span class="ss">&quot;user&quot;</span> <span class="p">:</span> <span class="ss">&quot;xiaodi&quot;</span><span class="p">,</span> <span class="ss">&quot;readOnly&quot;</span> <span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="ss">&quot;pwd&quot;</span> <span class="p">:</span> <span class="ss">&quot;8cb78b1a918c6c5cca2b9cea00673180&quot;</span> <span class="err">}</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fbb5cc7124f3221f45162b6&quot;</span><span class="p">),</span> <span class="ss">&quot;user&quot;</span> <span class="p">:</span> <span class="ss">&quot;longtao&quot;</span><span class="p">,</span> <span class="ss">&quot;readOnly&quot;</span> <span class="p">:</span> <span class="k">true</span><span class="p">,</span> <span class="ss">&quot;pwd&quot;</span> <span class="p">:</span> <span class="ss">&quot;fe130c893dd5c69a5a1cb96feba00f7d&quot;</span> <span class="err">}</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">removeUser</span><span class="p">(</span> <span class="n">username</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>删除用户, 以下两种方法效果一样:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">db</span><span class="p">.</span><span class="n">removeUser</span><span class="p">(</span><span class="ss">&quot;longtao&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">db</span><span class="p">.</span><span class="k">system</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="err">{</span><span class="k">user</span><span class="p">:</span> <span class="ss">&quot;longtao&quot;</span><span class="err">}</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a id="Port"></a><a href="#TOP">Port</a></h3>

<p>数据库默认端口:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Standalone mongod : 27017
</span><span class='line'>mongos : 27017
</span><span class='line'>shard server (mongod --shardsvr) : 27018
</span><span class='line'>config server (mongod --configsvr) : 27019</span></code></pre></td></tr></table></div></figure>


<h2><a id="Prepare"></a><a href="#TOP">准备工作</a></h2>

<p>第一步, 创建一个Rails App:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails new neten -T -O
</span></code></pre></td></tr></table></div></figure>


<p>用-T -O 是为了不产生Test::Unit 和 Active Record 文件. 由rails产生的Gemfile修改后的内容如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;~&gt; 3.2.3&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.1&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.0.3&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;mongoid&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.4&quot;</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;bson_ext&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.5&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后两行是mongoid相关的.</p>

<p>为项目管理方便, 可以创建gemset, 并设置它作为默认的gemset</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rvm --create 1.9.3@neten
</span><span class='line'><span class="nv">$ </span>rvm --default use 1.9.3@neten
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;rvm 1.9.3@neten&quot;</span> &gt; .rvmrc
</span></code></pre></td></tr></table></div></figure>


<p>安装gems, 并检查本机安装的gems, 最好把Gemfile里面的gems都按<code>gem list</code>所显示的标上版本号, 这样在远程部署的时候就不会出现版本问题.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle install
</span><span class='line'><span class="nv">$ </span>gem list --local
</span></code></pre></td></tr></table></div></figure>


<p>为了简化过程, 在此就不涉及RSpec了, 但无用的test模块可以删除.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rm -rf <span class="nb">test</span>/
</span><span class='line'><span class="nv">$ </span>vi config/application.rb
</span><span class='line'><span class="c"># ...</span>
</span><span class='line'><span class="c"># require &#39;rails/test_unit/railtie&#39;</span>
</span><span class='line'><span class="c"># ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用Mongoid, 执行下面的命令后, 会生成配置文件<code>config/mongoid.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails generate mongoid:config
</span></code></pre></td></tr></table></div></figure>


<p>Mongoid会自动处理<code>config/application.rb</code>文件, 禁用ActiveRecord, <code>require 'rails/all'</code>会被以下代码替代:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;action_controller/railtie&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;action_mailer/railtie&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;active_resource/railtie&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>原来的数据库配置文件<code>config/database.yml</code>可以删除了.</p>

<h2><a id="Git"></a><a href="#TOP">Git</a></h2>

<p>做了这么多工作, git是时候要登场了:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi .gitignore
</span><span class='line'>.bundle
</span><span class='line'>db/*.sqlite3*
</span><span class='line'>log/*.log
</span><span class='line'>*.log
</span><span class='line'>tmp/**/*
</span><span class='line'>tmp/*
</span><span class='line'>doc/api
</span><span class='line'>doc/app
</span><span class='line'>*.swp
</span><span class='line'>*~
</span><span class='line'>.*~
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>git init
</span><span class='line'>Initialized empty Git repository in /home/user/neten/.git/
</span><span class='line'><span class="nv">$ </span>git add .
</span><span class='line'><span class="nv">$ </span>git commit -am <span class="s2">&quot;Initial commit&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a id="Scaffold"></a><a href="#TOP">Scaffold</a></h2>

<p>用 scaffold 生成文章系统, 主要copy于<a href="http://railscasts.com/episodes/238-mongoid?view=asciicast">railscasts</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails g scaffold article name:string content:text
</span><span class='line'>      invoke  mongoid
</span><span class='line'>      create    app/models/article.rb
</span><span class='line'>       route  resources :articles
</span><span class='line'>      invoke  scaffold_controller
</span><span class='line'>      create    app/controllers/articles_controller.rb
</span><span class='line'>      invoke    erb
</span><span class='line'>      create      app/views/articles
</span><span class='line'>      create      app/views/articles/index.html.erb
</span><span class='line'>      create      app/views/articles/edit.html.erb
</span><span class='line'>      create      app/views/articles/show.html.erb
</span><span class='line'>      create      app/views/articles/new.html.erb
</span><span class='line'>      create      app/views/articles/_form.html.erb
</span><span class='line'>      invoke    helper
</span><span class='line'>      create      app/helpers/articles_helper.rb
</span><span class='line'>      invoke  assets
</span><span class='line'>      invoke    coffee
</span><span class='line'>      create      app/assets/javascripts/articles.js.coffee
</span><span class='line'>      invoke    scss
</span><span class='line'>      create      app/assets/stylesheets/articles.css.scss
</span><span class='line'>      invoke  scss
</span><span class='line'>      create    app/assets/stylesheets/scaffolds.css.scss
</span></code></pre></td></tr></table></div></figure>


<p>事就这么成了:)  <code>rake db:migrate</code>? 不用了, MongoDB是schemaless database.</p>

<p>因为首页还是默认的Welcome页面, 所以要处理一下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rm public/index.html
</span><span class='line'><span class="nv">$ </span>vi config/routes.rb
</span><span class='line'>Neten::Application.routes.draw <span class="k">do</span>
</span><span class='line'><span class="k">  </span>resources :articles
</span><span class='line'>  root :to <span class="o">=</span>&gt; <span class="s1">&#39;articles#index&#39;</span>
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>现在去<a href="http://localhost:3000">http://localhost:3000</a> 预览一下吧</p>

<h3><a id="AddField"></a><a href="#TOP">添加字段</a></h3>

<p>Mongoid为model提供了generator, <code>ActiveRecord</code>没有用到, 包含了<code>Mongoid::Document</code>,如果到现在才发现没有加入文章发布时间也关系不大, MongoDB嘛, schema-less, 好处就是在model直接加个字段名称就好了, 不用在db文件夹那里添加东西了.</p>

<p>另外因为加入了<code>Date</code>类型的字段, 所以要加上这句<code>include Mongoid::MultiParameterAttributes</code>, <a href="http://stackoverflow.com/questions/7620047">不然没办法显示出来</a>.</p>

<figure class='code'><figcaption><span>/app/models/article.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Article</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">MultiParameterAttributes</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:published_on</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Date</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>view也要相应改一下:</p>

<figure class='code'><figcaption><span>/app/views/articles/_form.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div class=&quot;field&quot;&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x">&lt;br /&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span><span class='line'><span class="x">&lt;div class=&quot;field&quot;&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:published_on</span> <span class="cp">%&gt;</span><span class="x">&lt;br /&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">date_select</span> <span class="ss">:published_on</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span><span class='line'><span class="x">&lt;div class=&quot;field&quot;&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:content</span> <span class="cp">%&gt;</span><span class="x">&lt;br /&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span><span class='line'><span class="x">&lt;div class=&quot;actions&quot;&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>/app/views/articles/show.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;p id=&quot;notice&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="n">notice</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;</span>
</span><span class='line'><span class="x">  &lt;b&gt;Name:&lt;/b&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;p&gt;</span>
</span><span class='line'><span class="x">  &lt;b&gt;Content:&lt;/b&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/p&gt;</span>
</span><span class='line'><span class="x">&lt;p&gt;</span>
</span><span class='line'><span class="x">  &lt;b&gt;Published:&lt;/b&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">published_on</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Edit&#39;</span><span class="p">,</span> <span class="n">edit_article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"> |</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Back&#39;</span><span class="p">,</span> <span class="n">articles_path</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">debug</span> <span class="vi">@article</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p><code>&lt;%= debug @article %&gt;</code> 是调试信息, 有这句话, 在前台页面上就会在页脚出现@article的信息.</p>

<h3><a id="Validations"></a><a href="#TOP">验证输入 Validations</a></h3>

<p>Mongoid 会使用 ActiveModel 来处理一些事务, 这就有点像我们熟悉的ActiveRecord一样. 比如说在ActiveRecord中用到的validations, callbacks, dirty tracking, attr_accessible都可以搬过来用.</p>

<p>下面我们为<code>:name</code>字段加上 必需输入 的验证要求:</p>

<figure class='code'><figcaption><span>/app/models/article.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Article</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">MultiParameterAttributes</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:published_on</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Date</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a id="Associations"></a><a href="#TOP">表关联 Associations</a></h3>

<p>不允许评论的blog会表现得有点言论暴力, 要加上<code>comments</code>在用数据库的情况下, 一个<code>has_many</code>, 就解决问题了, 现在我们就要在mongoid中寻找<code>has_many</code>的替代了.</p>

<figure class='code'><figcaption><span>/app/models/article.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Article</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">MultiParameterAttributes</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:published_on</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Date</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">embeds_many</span> <span class="ss">:comments</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>添加完关联后, 来生成评论model</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails g model comment name:string content:text
</span><span class='line'>      invoke  mongoid
</span><span class='line'>      create    app/models/comment.rb
</span></code></pre></td></tr></table></div></figure>


<p>再让comment和article手拉手:</p>

<figure class='code'><figcaption><span>app/models/comment.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Comment</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:content</span>
</span><span class='line'>  <span class="n">embedded_in</span> <span class="ss">:article</span><span class="p">,</span> <span class="ss">:inverse_of</span> <span class="o">=&gt;</span> <span class="ss">:comments</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>embedded_in</code>顾名思意就是说Comment是嵌在Article里面的, <code>inverse_of</code>呢是表明comment是通过comments嵌套在Article里面的.</p>

<p>这个手拉手的关系也要在routes里面申明一下:</p>

<figure class='code'><figcaption><span>confing/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Neten</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:articles</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">resources</span> <span class="ss">:comments</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>好了, 现在创建comment的controller</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails g controller comments
</span><span class='line'>      create  app/controllers/comments_controller.rb
</span><span class='line'>      invoke  erb
</span><span class='line'>      create    app/views/comments
</span><span class='line'>      invoke  helper
</span><span class='line'>      create    app/helpers/comments_helper.rb
</span><span class='line'>      invoke  assets
</span><span class='line'>      invoke    coffee
</span><span class='line'>      create      app/assets/javascripts/comments.js.coffee
</span><span class='line'>      invoke    scss
</span><span class='line'>      create      app/assets/stylesheets/comments.css.scss
</span></code></pre></td></tr></table></div></figure>


<p>Comment和Article手拉手之后, 一切都要看Article的眼色(:article_id)行事</p>

<figure class='code'><figcaption><span>app/controllers/comments_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CommentsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:article_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@comment</span> <span class="o">=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:comment</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="vi">@article</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Comment created!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>在<code>app/views/articles/show.html.erb</code>的最后面加上comments的代码:</p>

<figure class='code'><figcaption><span>app/views/articles/show.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@article</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;h2&gt;Comments&lt;/h2&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">for</span> <span class="n">comment</span> <span class="k">in</span> <span class="vi">@article</span><span class="o">.</span><span class="n">comments</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    &lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="n">comment</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x">&lt;/h3&gt;</span>
</span><span class='line'><span class="x">    &lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">comment</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;h2&gt;New Comment&lt;/h2&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="o">[</span><span class="vi">@article</span><span class="p">,</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"> </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span><span class='line'><span class="x">  &lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:rows</span> <span class="o">=&gt;</span> <span class="mi">10</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span><span class='line'><span class="x">  &lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>好, 现在打开网站尽情地发表自己的观点吧.</p>

<h3><a id="ReferenceTypeAssociations"></a><a href="#TOP">引用关联 Reference Type Associations</a></h3>

<p>有的blog可能是夫妻店, 所以把Blog的作者放到文章里面还是很有用处的, scaffold又要上班了.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails g scaffold author name:string
</span><span class='line'>      invoke  mongoid
</span><span class='line'>      create    app/models/author.rb
</span><span class='line'>       route  resources :authors
</span><span class='line'>      invoke  scaffold_controller
</span><span class='line'>      create    app/controllers/authors_controller.rb
</span><span class='line'>      invoke    erb
</span><span class='line'>      create      app/views/authors
</span><span class='line'>      create      app/views/authors/index.html.erb
</span><span class='line'>      create      app/views/authors/edit.html.erb
</span><span class='line'>      create      app/views/authors/show.html.erb
</span><span class='line'>      create      app/views/authors/new.html.erb
</span><span class='line'>      create      app/views/authors/_form.html.erb
</span><span class='line'>      invoke    helper
</span><span class='line'>      create      app/helpers/authors_helper.rb
</span><span class='line'>      invoke  assets
</span><span class='line'>      invoke    coffee
</span><span class='line'>      create      app/assets/javascripts/authors.js.coffee
</span><span class='line'>      invoke    scss
</span><span class='line'>      create      app/assets/stylesheets/authors.css.scss
</span><span class='line'>      invoke  scss
</span><span class='line'>   identical    app/assets/stylesheets/scaffolds.css.scss
</span></code></pre></td></tr></table></div></figure>


<p>添加一个key字段, 这样可以在生成链接的时候, 将小写的:name字段做链接名称, 并在表中作_id. 中文没有小写, 不过没关系, 直接用汉字做链接, 比如: <code>http://localhost:3000/authors/张三/edit</code>, <code>references_many</code>可以定义其与articles的关系.</p>

<figure class='code'><figcaption><span>app/models/author.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Author</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">key</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">references_many</span> <span class="ss">:articles</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>用这个链接可以添加一些作者 <a href="http://localhost:3000/authors/">http://localhost:3000/authors/</a>
添加过后去命令行看一下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="n">use</span> <span class="n">neten_development</span>
</span><span class='line'><span class="n">switched</span> <span class="k">to</span> <span class="n">db</span> <span class="n">neten_development</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">authors</span><span class="p">.</span><span class="n">find</span><span class="p">()</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="ss">&quot;peter&quot;</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span> <span class="p">:</span> <span class="ss">&quot;Peter&quot;</span> <span class="err">}</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="ss">&quot;paul&quot;</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span> <span class="p">:</span> <span class="ss">&quot;Paul&quot;</span> <span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在<code>app/models/article.rb</code>里面要用<code>referenced_in</code>.</p>

<figure class='code'><figcaption><span>app/models/article.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Article</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:content</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:published_on</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Date</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">embeds_many</span> <span class="ss">:comments</span>
</span><span class='line'>  <span class="n">referenced_in</span> <span class="ss">:author</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了方便写Blog的人能够添加作者, 我们可以建立一个Select代码.</p>

<figure class='code'><figcaption><span>app/views/articles/_form.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div class=&quot;field&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:author_id</span> <span class="cp">%&gt;</span><span class="x">&lt;br /&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">collection_select</span> <span class="ss">:author_id</span><span class="p">,</span> <span class="no">Author</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然不要忘记在展示页面也要让作者出现, 因为前面有可能没有定义作者, 还是加个if吧, 这样不会出错.</p>

<figure class='code'><figcaption><span>app/views/articles/show.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@article</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;p&gt;</span>
</span><span class='line'><span class="x">  &lt;b&gt;Author:&lt;/b&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/p&gt;</span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>最后总结一下Comment和Author, 因为Comments是Embeded在Articles中的, 所以它就是个附庸, 没有自己的家(Collection), 而Author是一个Reference, 所以它有自己的房子(Collection).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="k">show</span> <span class="n">collections</span>
</span><span class='line'><span class="n">articles</span>
</span><span class='line'><span class="n">authors</span>
</span><span class='line'><span class="k">system</span><span class="p">.</span><span class="n">indexes</span>
</span></code></pre></td></tr></table></div></figure>


<p>从Rails控制台检索一下结果:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">c</span>
</span><span class='line'><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p194</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">Article</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;Article _id: 4fbd001de6fc8c2470000002, _type: nil, name: &quot;first&quot;, content: &quot;first post&quot;, published_on: 2012-03-03 00:00:00 UTC, author_id: &quot;peter&quot;, published_on(1i): &quot;2012&quot;, published_on(2i): &quot;3&quot;, published_on(3i): &quot;3&quot;&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p194</span> <span class="p">:</span><span class="mo">00</span><span class="mi">9</span> <span class="o">&gt;</span> <span class="no">Article</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">comments</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;Comment _id: 4fbe5755e6fc8c6c3f000004, _type: nil, name: &quot;good&quot;, content: &quot;this is a awesome blog&quot;&gt;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>从MongoDB的命令行检索一下, 和上面作个对比:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="err">$</span> <span class="n">mongo</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">use</span> <span class="n">neten_development</span>
</span><span class='line'><span class="n">switched</span> <span class="k">to</span> <span class="n">db</span> <span class="n">neten_development</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">articles</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="err">{</span><span class="n">name</span><span class="p">:</span> <span class="ss">&quot;first&quot;</span><span class="err">}</span><span class="p">)</span>
</span><span class='line'><span class="err">{</span> <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fbd001de6fc8c2470000002&quot;</span><span class="p">),</span> <span class="ss">&quot;author_id&quot;</span> <span class="p">:</span> <span class="ss">&quot;peter&quot;</span><span class="p">,</span> <span class="ss">&quot;comments&quot;</span> <span class="p">:</span> <span class="p">[</span>  <span class="err">{</span>  <span class="ss">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="ss">&quot;4fbe5755e6fc8c6c3f000004&quot;</span><span class="p">),</span>   <span class="ss">&quot;name&quot;</span> <span class="p">:</span> <span class="ss">&quot;good&quot;</span><span class="p">,</span>  <span class="ss">&quot;content&quot;</span> <span class="p">:</span> <span class="ss">&quot;this is a awesome blog&quot;</span> <span class="err">}</span> <span class="p">],</span> <span class="ss">&quot;content&quot;</span> <span class="p">:</span> <span class="ss">&quot;first post&quot;</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span> <span class="p">:</span> <span class="ss">&quot;first&quot;</span><span class="p">,</span> <span class="ss">&quot;published_on&quot;</span> <span class="p">:</span> <span class="n">ISODate</span><span class="p">(</span><span class="ss">&quot;2012-03-03T00:00:00Z&quot;</span><span class="p">),</span> <span class="ss">&quot;published_on(1i)&quot;</span> <span class="p">:</span> <span class="ss">&quot;2012&quot;</span><span class="p">,</span> <span class="ss">&quot;published_on(2i)&quot;</span> <span class="p">:</span> <span class="ss">&quot;3&quot;</span><span class="p">,</span> <span class="ss">&quot;published_on(3i)&quot;</span> <span class="p">:</span> <span class="ss">&quot;3&quot;</span> <span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[sed 批量替换文件中的字符]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/05/16/sed-pi-liang-ti-huan-wen-jian-zhong-de-zi-fu/"/>
    <updated>2012-05-16T20:49:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/05/16/sed-pi-liang-ti-huan-wen-jian-zhong-de-zi-fu</id>
    <content type="html"><![CDATA[<p>下载了ruby的Standard Library Documentation, 发现其离线版本的home链接居然是&#8217;/&#8217;, 这在使用中会指向file:///, 所以还是替换一下吧:
把</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&#39;/&#39;</span> <span class="na">target=</span><span class="s">&#39;_top&#39;</span> <span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>替换成</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&#39;index&#39;</span> <span class="na">target=</span><span class="s">&#39;_top&#39;</span> <span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>用这个命令:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sed -i -e <span class="s2">&quot;s/&#39;\/&#39; target/&#39;\/index.html&#39; target/g&quot;</span> *.html
</span></code></pre></td></tr></table></div></figure>


<p>如果想替换前做个备份:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sed -i.bak -e <span class="s2">&quot;s/&#39;\/&#39; target/&#39;\/index.html&#39; target/g&quot;</span> *.html
</span></code></pre></td></tr></table></div></figure>


<p>如果想把当前目录及子目录下的文件都替换掉, 那可以这样写:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>find . -type f | xargs sed -i.bak -e <span class="s2">&quot;s/&#39;\/&#39; target/&#39;\/index.html&#39; target/g&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然这只是个例子, 因为子目录下的html文件中的home链接如果也换成了index.html, 那还是不能链接到父目录中的index.html.</p>

<p>因为换成了octopress, 所以留言也托管到disqus了, 导入留言后, 发现blog下方的留言不能显示, 查看源代码发现链接最后没有斜线 &#8220;/&#8221;, 我在disqus里面换链接的时候, 设置成都以斜线结尾.</p>

<!-- more -->


<figure class='code'><figcaption><span>链接最后没有斜线</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">disqus_shortname</span> <span class="o">=</span> <span class="s1">&#39;neten&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// var disqus_developer = 1;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">disqus_identifier</span> <span class="o">=</span> <span class="s1">&#39;http://blog.neten.de/posts/345/&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">disqus_url</span> <span class="o">=</span> <span class="s1">&#39;http://blog.neten.de/posts/345/&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">disqus_script</span> <span class="o">=</span> <span class="s1">&#39;embed.js&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">dsq</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span> <span class="nx">dsq</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">;</span> <span class="nx">dsq</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">dsq</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="nx">disqus_shortname</span> <span class="o">+</span> <span class="s1">&#39;.disqus.com/&#39;</span> <span class="o">+</span> <span class="nx">disqus_script</span><span class="p">;</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">dsq</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}());</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>打开source/_posts/2012-03-25-345.textile</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>permalink: /posts/345</span></code></pre></td></tr></table></div></figure>


<p>发现345后面没有斜线, 如果在vi里面可以这样替换掉:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:g/\(permalink:\s\/posts\/\d\+\)$/s//\1\//g</span></code></pre></td></tr></table></div></figure>


<p>但面对 source/_posts/下面二百多篇文章, 一个一个加斜线显然不现实, 那只好请出强大的sed</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sed -i -e <span class="s1">&#39;s/permalink:\(.*$\)/permalink:\1\//g&#39;</span> *.textile
</span></code></pre></td></tr></table></div></figure>


<p>最后再写一个<a href="http://www.tutorialspoint.com/unix/unix-regular-expressions.htm">网上</a>看到的处理电话号码的scripts作为结束吧.
一个文本文件phone.txt里面包含内容如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>5555551212
</span><span class='line'>5555551213
</span><span class='line'>5555551214
</span><span class='line'>6665551215
</span><span class='line'>6665551216
</span><span class='line'>7775551217</span></code></pre></td></tr></table></div></figure>


<p>前三位是区号, 要用()包起来, 使用&#8221;&amp;&#8221;来匹配前面查找的内容:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sed -e <span class="s1">&#39;s/^[[:digit:]][[:digit:]][[:digit:]]/(&amp;)/g&#39;</span> phone.txt
</span></code></pre></td></tr></table></div></figure>


<p>参数不含&#8221;-i&#8221;, 所以不会改动文件, 只会显示结果如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(555)5551212
</span><span class='line'>(555)5551213
</span><span class='line'>(555)5551214
</span><span class='line'>(666)5551215
</span><span class='line'>(666)5551216
</span><span class='line'>(777)5551217</span></code></pre></td></tr></table></div></figure>


<p>如果想先把区位用括号包起来, 然后在这之后的第三位想再加入一个&#8221;-&#8220;, 这时可以多个命令一起用:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sed -e <span class="s1">&#39;command1&#39;</span> -e <span class="s1">&#39;command2&#39;</span> ... -e <span class="s1">&#39;commandN&#39;</span> files
</span></code></pre></td></tr></table></div></figure>


<p>例子:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sed -e <span class="s1">&#39;s/^[[:digit:]]\{3\}/(&amp;)/g&#39;</span> -e <span class="s1">&#39;s/)[[:digit:]]\{3\}/&amp;-/g&#39;</span> phone.txt
</span></code></pre></td></tr></table></div></figure>


<p>结果如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(555)555-1212
</span><span class='line'>(555)555-1213
</span><span class='line'>(555)555-1214
</span><span class='line'>(666)555-1215
</span><span class='line'>(666)555-1216
</span><span class='line'>(777)555-1217</span></code></pre></td></tr></table></div></figure>


<p>如果想表达得更清楚, 可以这样玩:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat phone.txt | sed <span class="s1">&#39;s/^(\(.*\))\(.*\)-\(.*$\)/Area code: \1 Second: \2 Third: \3/&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>结果如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Area code: 555 Second: 555 Third: 1212
</span><span class='line'>Area code: 555 Second: 555 Third: 1213
</span><span class='line'>Area code: 555 Second: 555 Third: 1214
</span><span class='line'>Area code: 666 Second: 555 Third: 1215
</span><span class='line'>Area code: 666 Second: 555 Third: 1216
</span><span class='line'>Area code: 777 Second: 555 Third: 1217</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Wordpress to Octopress rewrite rules]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/05/16/wordpress-to-octopress-rewrite-rules/"/>
    <updated>2012-05-16T14:45:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/05/16/wordpress-to-octopress-rewrite-rules</id>
    <content type="html"><![CDATA[<ol>
<li>首先编辑Gemfile, 添加gem &#8216;rack-rewrite&#8217;</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi Gemfile
</span><span class='line'><span class="nb">source</span> <span class="s2">&quot;http://rubygems.org&quot;</span>
</span><span class='line'>
</span><span class='line'>group :development <span class="k">do</span>
</span><span class='line'><span class="k">  </span>gem <span class="s1">&#39;rake&#39;</span>
</span><span class='line'>  ...
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>gem <span class="s1">&#39;sinatra&#39;</span>, <span class="s1">&#39;1.2.6&#39;</span>
</span><span class='line'>gem <span class="s1">&#39;rack-rewrite&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在config.ru里面添加rewrite规则</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi config.ru
</span><span class='line'>...
</span><span class='line'>require <span class="s1">&#39;rack-rewrite&#39;</span>
</span><span class='line'>
</span><span class='line'>use Rack::Rewrite <span class="k">do</span>
</span><span class='line'><span class="k">  </span>r301 %r<span class="o">{</span>/<span class="se">\?</span><span class="nv">p</span><span class="o">=(</span>.*<span class="o">)}</span>,  <span class="s2">&quot;http://blog.neten.de/posts/$1/&quot;</span>
</span><span class='line'>end
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>别忘记了更新网站</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle install
</span><span class='line'><span class="nv">$ </span>rake generate
</span><span class='line'><span class="nv">$ </span>git add .
</span><span class='line'><span class="nv">$ </span>git commit -am <span class="s2">&quot;add rewrite&quot;</span>
</span><span class='line'><span class="nv">$ </span>git push heroku master
</span></code></pre></td></tr></table></div></figure>


<p>访问一下Google中网站的旧链接吧, 是不是转到新站上来了呢?</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[first blog using octopress]]></title>
    <link href="http://ZPVIP.github.io/posts/2012/05/14/first-blog-using-octopress/"/>
    <updated>2012-05-14T22:19:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/2012/05/14/first-blog-using-octopress</id>
    <content type="html"><![CDATA[<p>Octopress 真是太棒了, 可以用vi来写blog, 用git来管理, 相当省心.</p>

<ul>
<li><strong> 首先下载一分代码 </strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git://github.com/imathis/octopress.git blog
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong> 我为octopress生成一个gems包, 进入目录的同时, 运行rvm use命令 </strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vi neten/.rvmrc
</span><span class='line'><span class="c"># rvm use 1.9.2</span>
</span><span class='line'>rvm use ruby-1.9.2-p290@octopress
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span><span class="nv">blog</span>
</span><span class='line'><span class="o">====================================================================================</span>
</span><span class='line'><span class="o">=</span> <span class="nv">NOTICE</span>                                                                           <span class="o">=</span>
</span><span class='line'><span class="o">====================================================================================</span>
</span><span class='line'><span class="o">=</span> RVM has encountered a new or modified .rvmrc file in the current <span class="nv">directory</span>       <span class="o">=</span>
</span><span class='line'><span class="o">=</span> This is a shell script and therefore may contain any shell commands.             <span class="o">=</span>
</span><span class='line'><span class="o">=</span>                                                                                  <span class="o">=</span>
</span><span class='line'><span class="o">=</span> Examine the contents of this file carefully to be sure the contents <span class="nv">are</span>          <span class="o">=</span>
</span><span class='line'><span class="o">=</span> safe before trusting it! <span class="o">(</span> Choose v<span class="o">[</span>iew<span class="o">]</span> below to view the contents <span class="o">)</span>            <span class="o">=</span>
</span><span class='line'><span class="o">====================================================================================</span>
</span><span class='line'>Do you wish to trust this .rvmrc file? <span class="o">(</span>/home/peng/Projects/RubySites/blog/.rvmrc<span class="o">)</span>
</span><span class='line'>y<span class="o">[</span>es<span class="o">]</span>, n<span class="o">[</span>o<span class="o">]</span>, v<span class="o">[</span>iew<span class="o">]</span>, c<span class="o">[</span>ancel<span class="o">]</span>&gt; y
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>ruby -v
</span><span class='line'>ruby 1.9.2p290 <span class="o">(</span>2011-07-09 revision 32553<span class="o">)</span> <span class="o">[</span>x86_64-linux<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<ul>
<li><strong> 安装缺少的包 </strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gem install bundler
</span><span class='line'>Successfully installed bundler-1.1.3
</span><span class='line'>1 gem installed
</span><span class='line'>Installing ri documentation <span class="k">for </span>bundler-1.1.3...
</span><span class='line'>Installing RDoc documentation <span class="k">for </span>bundler-1.1.3...
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>bundle install
</span><span class='line'>Using rake <span class="o">(</span>0.9.2<span class="o">)</span>
</span><span class='line'>Using RedCloth <span class="o">(</span>4.2.8<span class="o">)</span>
</span><span class='line'>Using posix-spawn <span class="o">(</span>0.3.6<span class="o">)</span>
</span><span class='line'>Using albino <span class="o">(</span>1.3.3<span class="o">)</span>
</span><span class='line'>Using blankslate <span class="o">(</span>2.1.2.4<span class="o">)</span>
</span><span class='line'>Using chunky_png <span class="o">(</span>1.2.1<span class="o">)</span>
</span><span class='line'>Using fast-stemmer <span class="o">(</span>1.0.0<span class="o">)</span>
</span><span class='line'>Using classifier <span class="o">(</span>1.3.3<span class="o">)</span>
</span><span class='line'>Using fssm <span class="o">(</span>0.2.7<span class="o">)</span>
</span><span class='line'>Using sass <span class="o">(</span>3.1.5<span class="o">)</span>
</span><span class='line'>Using compass <span class="o">(</span>0.11.5<span class="o">)</span>
</span><span class='line'>Using directory_watcher <span class="o">(</span>1.4.0<span class="o">)</span>
</span><span class='line'>Using ffi <span class="o">(</span>1.0.9<span class="o">)</span>
</span><span class='line'>Using haml <span class="o">(</span>3.1.2<span class="o">)</span>
</span><span class='line'>Using kramdown <span class="o">(</span>0.13.3<span class="o">)</span>
</span><span class='line'>Using liquid <span class="o">(</span>2.2.2<span class="o">)</span>
</span><span class='line'>Using syntax <span class="o">(</span>1.0.0<span class="o">)</span>
</span><span class='line'>Using maruku <span class="o">(</span>0.6.0<span class="o">)</span>
</span><span class='line'>Using jekyll <span class="o">(</span>0.11.0<span class="o">)</span>
</span><span class='line'>Using rubypython <span class="o">(</span>0.5.1<span class="o">)</span>
</span><span class='line'>Using pygments.rb <span class="o">(</span>0.1.3<span class="o">)</span>
</span><span class='line'>Using rack <span class="o">(</span>1.3.2<span class="o">)</span>
</span><span class='line'>Using rb-fsevent <span class="o">(</span>0.4.3.1<span class="o">)</span>
</span><span class='line'>Using rdiscount <span class="o">(</span>1.6.8<span class="o">)</span>
</span><span class='line'>Using rubypants <span class="o">(</span>0.2.0<span class="o">)</span>
</span><span class='line'>Using tilt <span class="o">(</span>1.3.2<span class="o">)</span>
</span><span class='line'>Using sinatra <span class="o">(</span>1.2.6<span class="o">)</span>
</span><span class='line'>Using stringex <span class="o">(</span>1.3.0<span class="o">)</span>
</span><span class='line'>Using bundler <span class="o">(</span>1.1.3<span class="o">)</span>
</span><span class='line'>Your bundle is <span class="nb">complete</span>! Use <span class="sb">`</span>bundle show <span class="o">[</span>gemname<span class="o">]</span><span class="sb">`</span> to see where a bundled gem is installed.
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong> Install the default Octopress theme </strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake install
</span><span class='line'>** Copying classic theme into ./source and ./sass
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>rake preview
</span><span class='line'>Starting to watch <span class="nb">source </span>with Jekyll and Compass. Starting Rack on port 4000
</span><span class='line'>directory <span class="nb">source</span>/stylesheets/
</span><span class='line'>   create <span class="nb">source</span>/stylesheets/screen.css
</span><span class='line'>Configuration from /home/neten/Projects/RubySites/blog/_config.yml
</span><span class='line'><span class="o">[</span>2012-05-14 22:10:42<span class="o">]</span> INFO  WEBrick 1.3.1
</span><span class='line'><span class="o">[</span>2012-05-14 22:10:42<span class="o">]</span> INFO  ruby 1.9.2 <span class="o">(</span>2011-07-09<span class="o">)</span> <span class="o">[</span>x86_64-linux<span class="o">]</span>
</span><span class='line'><span class="o">[</span>2012-05-14 22:10:42<span class="o">]</span> INFO  WEBrick::HTTPServer#start: <span class="nv">pid</span><span class="o">=</span>4578 <span class="nv">port</span><span class="o">=</span>4000
</span><span class='line'>&gt;&gt;&gt; Change detected to: screen.scss
</span><span class='line'>Auto-regenerating enabled: <span class="nb">source</span> -&gt; public
</span><span class='line'><span class="o">[</span>2012-05-14 22:10:43<span class="o">]</span> regeneration: 94 files changed
</span><span class='line'>127.0.0.1 - - <span class="o">[</span>14/May/2012 22:10:43<span class="o">]</span> <span class="s2">&quot;GET / HTTP/1.1&quot;</span> 200 3040 0.0165
</span><span class='line'>127.0.0.1 - - <span class="o">[</span>14/May/2012 22:10:43<span class="o">]</span> <span class="s2">&quot;GET /stylesheets/screen.css HTTP/1.1&quot;</span> 200 44900 0.0030
</span><span class='line'>127.0.0.1 - - <span class="o">[</span>14/May/2012 22:10:43<span class="o">]</span> <span class="s2">&quot;GET /javascripts/octopress.js HTTP/1.1&quot;</span> 200 8829 0.0018
</span><span class='line'>127.0.0.1 - - <span class="o">[</span>14/May/2012 22:10:43<span class="o">]</span> <span class="s2">&quot;GET /javascripts/ender.js HTTP/1.1&quot;</span> 200 30652 0.0091
</span><span class='line'>127.0.0.1 - - <span class="o">[</span>14/May/2012 22:10:43<span class="o">]</span> <span class="s2">&quot;GET /javascripts/modernizr-2.0.js HTTP/1.1&quot;</span> 200 9946 0.0131
</span><span class='line'>identical public/stylesheets/screen.css
</span><span class='line'>FSSM -&gt; An optimized backend is available <span class="k">for </span>this platform!
</span><span class='line'>FSSM -&gt;     gem install rb-inotify
</span><span class='line'>&gt;&gt;&gt; Compass is polling <span class="k">for </span>changes. Press Ctrl-C to Stop.
</span></code></pre></td></tr></table></div></figure>


<p>好了, blog能访问了: <a href="http://localhost:4000" title="本地测试链接">http://localhost:4000</a></p>

<ul>
<li><strong> 下一步, 就是配置blog了 </strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi _config.yml
</span><span class='line'>...
</span><span class='line'>url: http://neten.heroku.com
</span><span class='line'>title: 简洁的想法
</span><span class='line'>subtitle: 仁爱、喜乐、和平、忍耐、恩慈、良善、信实、温柔、节制 。
</span><span class='line'>author: Peter
</span><span class='line'>...
</span><span class='line'>permalink: /posts/:year/:month-:day/:title/
</span><span class='line'>...
</span><span class='line'>category_dir: posts/categories
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong> 写篇文章看看 </strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake new_post<span class="o">[</span><span class="s2">&quot;first blog using octopress&quot;</span><span class="o">]</span>
</span><span class='line'>Creating new post: <span class="nb">source</span>/_posts/2012-05-14-first-blog-using-octopress.markdown
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>vi <span class="nb">source</span>/_posts/2012-05-14-first-blog-using-octopress.markdown
</span></code></pre></td></tr></table></div></figure>


<p>写完之后:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake generate
</span><span class='line'>** Generating Site with Jekyll
</span><span class='line'>unchanged sass/screen.scss
</span><span class='line'>Configuration from /home/neten/Projects/RubySites/blog/_config.yml
</span><span class='line'>Building site: <span class="nb">source</span> -&gt; public
</span><span class='line'>Successfully generated site: <span class="nb">source</span> -&gt; public
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong> Using Octopress With Heroku </strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gem install heroku
</span><span class='line'>Fetching: netrc-0.7.1.gem <span class="o">(</span>100%<span class="o">)</span>
</span><span class='line'>Fetching: mime-types-1.18.gem <span class="o">(</span>100%<span class="o">)</span>
</span><span class='line'>Fetching: rest-client-1.6.7.gem <span class="o">(</span>100%<span class="o">)</span>
</span><span class='line'>Fetching: addressable-2.2.8.gem <span class="o">(</span>100%<span class="o">)</span>
</span><span class='line'>Fetching: launchy-2.1.0.gem <span class="o">(</span>100%<span class="o">)</span>
</span><span class='line'>Fetching: rubyzip-0.9.8.gem <span class="o">(</span>100%<span class="o">)</span>
</span><span class='line'>Fetching: heroku-2.25.0.gem <span class="o">(</span>100%<span class="o">)</span>
</span><span class='line'>Successfully installed netrc-0.7.1
</span><span class='line'>Successfully installed mime-types-1.18
</span><span class='line'>Successfully installed rest-client-1.6.7
</span><span class='line'>Successfully installed addressable-2.2.8
</span><span class='line'>Successfully installed launchy-2.1.0
</span><span class='line'>Successfully installed rubyzip-0.9.8
</span><span class='line'>Successfully installed heroku-2.25.0
</span><span class='line'>7 gems installed
</span><span class='line'>Installing ri documentation <span class="k">for </span>netrc-0.7.1...
</span><span class='line'>Installing ri documentation <span class="k">for </span>mime-types-1.18...
</span><span class='line'>Installing ri documentation <span class="k">for </span>rest-client-1.6.7...
</span><span class='line'>Installing ri documentation <span class="k">for </span>addressable-2.2.8...
</span><span class='line'>Installing ri documentation <span class="k">for </span>launchy-2.1.0...
</span><span class='line'>Installing ri documentation <span class="k">for </span>rubyzip-0.9.8...
</span><span class='line'>Installing ri documentation <span class="k">for </span>heroku-2.25.0...
</span><span class='line'>Installing RDoc documentation <span class="k">for </span>netrc-0.7.1...
</span><span class='line'>Installing RDoc documentation <span class="k">for </span>mime-types-1.18...
</span><span class='line'>Installing RDoc documentation <span class="k">for </span>rest-client-1.6.7...
</span><span class='line'>Installing RDoc documentation <span class="k">for </span>addressable-2.2.8...
</span><span class='line'>Installing RDoc documentation <span class="k">for </span>launchy-2.1.0...
</span><span class='line'>Installing RDoc documentation <span class="k">for </span>rubyzip-0.9.8...
</span><span class='line'>Installing RDoc documentation <span class="k">for </span>heroku-2.25.0...
</span></code></pre></td></tr></table></div></figure>


<p>这一步会把 ~/.ssh/id_rsa.pub 上传到heroku服务器, 因为我原来已经上传了, 所以没有输出相关信息.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>heroku create neten
</span><span class='line'>Creating neten... <span class="k">done</span>, stack is bamboo-mri-1.9.2
</span><span class='line'>http://neten.heroku.com/ | git@heroku.com:neten.git
</span><span class='line'>Git remote heroku added
</span></code></pre></td></tr></table></div></figure>


<p>在运行git之前, 不要忘记这一步:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi .gitignore
</span></code></pre></td></tr></table></div></figure>


<p>然后把public给删除了, 因为heroku不会让运行代码你生成html文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git config branch.master.remote neten
</span><span class='line'><span class="nv">$ </span>git add .
</span><span class='line'><span class="nv">$ </span>git commit -m <span class="s2">&quot;first blog&quot;</span>
</span><span class='line'><span class="o">[</span>master 7bfcebf<span class="o">]</span> first blog
</span><span class='line'> 184 files changed, 7354 insertions<span class="o">(</span>+<span class="o">)</span>, 10 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>git push heroku master
</span><span class='line'>Counting objects: 3977, <span class="k">done</span>.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% <span class="o">(</span>1385/1385<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'>Writing objects: 100% <span class="o">(</span>3977/3977<span class="o">)</span>, 921.28 KiB | 2 KiB/s, <span class="k">done</span>.
</span><span class='line'>Total 3977 <span class="o">(</span>delta 2277<span class="o">)</span>, reused 3935 <span class="o">(</span>delta 2268<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>-----&gt; Heroku receiving push
</span><span class='line'>-----&gt; Ruby/Sinatra app detected
</span><span class='line'>-----&gt; Gemfile detected, running Bundler version 1.0.7
</span><span class='line'>       Unresolved dependencies detected; Installing...
</span><span class='line'>       Using --without development:test
</span><span class='line'>       Fetching <span class="nb">source </span>index <span class="k">for </span>http://rubygems.org/
</span><span class='line'>       Installing rack <span class="o">(</span>1.3.2<span class="o">)</span>
</span><span class='line'>       Installing tilt <span class="o">(</span>1.3.2<span class="o">)</span>
</span><span class='line'>       Installing sinatra <span class="o">(</span>1.2.6<span class="o">)</span>
</span><span class='line'>       Using bundler <span class="o">(</span>1.0.7<span class="o">)</span>
</span><span class='line'>       Your bundle is <span class="nb">complete</span>! It was installed into ./.bundle/gems/
</span><span class='line'>-----&gt; Compiled slug size is 624K
</span><span class='line'>-----&gt; Launching... <span class="k">done</span>, v3
</span><span class='line'>       http://neten.heroku.com deployed to Heroku
</span><span class='line'>
</span><span class='line'>To git@heroku.com:neten.git
</span><span class='line'> * <span class="o">[</span>new branch<span class="o">]</span>      master -&gt; master
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[如何使用ActiveRecordStore（数据库）做为session存储方案 ]]></title>
    <link href="http://ZPVIP.github.io/posts/345/"/>
    <updated>2012-03-25T00:00:00+01:00</updated>
    <id>http://ZPVIP.github.io/posts/345</id>
    <content type="html"><![CDATA[<p>首先交待环境：<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ruby -v
</span><span class='line'>ruby 1.9.3p125 <span class="o">(</span>2012-02-16 revision 34643<span class="o">)</span> <span class="o">[</span>x86_64-linux<span class="o">]</span>
</span><span class='line'><span class="nv">$ </span>rails -v
</span><span class='line'>Rails 3.2.2
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>网上一大堆过期信息， 说是可以用下面的方法， 结果如下：<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ rake db:session:create
</span><span class='line'>rake aborted!
</span><span class='line'>Don&#39;t know how to build task &#39;db:session:create&#39;
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>其实大家找一下session的配置文件就可以发现正确方法了：<br />
config/initializers/session_store.rb<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Be sure to restart your server when you modify this file.</span>
</span><span class='line'>
</span><span class='line'><span class="no">Neten</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="s1">&#39;_neten_session&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Use the database for sessions instead of the cookie-based default,</span>
</span><span class='line'><span class="c1"># which shouldn&#39;t be used to store highly confidential information</span>
</span><span class='line'><span class="c1"># (create the session table with &quot;rails generate session_migration&quot;)</span>
</span><span class='line'><span class="c1"># Neten::Application.config.session_store :active_record_store</span>
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>正确的方法是运行<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails generate session_migration
</span></code></pre></td></tr></table></div></figure></div></notextile><br />
或者用原来的命令， 不过session要加个s：<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake db:sessions:create
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>再把session_store.rb最后一行去掉注释， 注释掉上面那行用cookie的， 最后运行：<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake db:migrate
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>别忘了重启服务器。</p>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[mysql 改变数据库目录不能启动]]></title>
    <link href="http://ZPVIP.github.io/posts/344/"/>
    <updated>2012-03-23T00:00:00+01:00</updated>
    <id>http://ZPVIP.github.io/posts/344</id>
    <content type="html"><![CDATA[<p>mysql默认的目录是/var/lib/mysql, 修改该目录看起来很简单:<br />
<div class='bogus-wrapper'><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo vi /etc/mysql/my.cnf
</span><span class='line'><span class="c">#datadir = /var/lib/mysql</span>
</span><span class='line'><span class="nv">datadir</span> <span class="o">=</span> /home/neten/mysql
</span></code></pre></td></tr></table></div></figure></div></p>
<p>没想到 /etc/init.d/mysql restart 的时候启动不了了。</p>
<p>查看 log 是个习惯：<br />
<div class='bogus-wrapper'><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tail -f /var/log/syslog
</span></code></pre></td></tr></table></div></figure></div></p>
<p>发现一堆这种信息：<br />
<div class='bogus-wrapper'><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Mar 23 16:00:40 HP kernel: <span class="o">[</span> 3898.064351<span class="o">]</span> <span class="nb">type</span><span class="o">=</span>1400 audit<span class="o">(</span>1332514840.079:153<span class="o">)</span>: <span class="nv">apparmor</span><span class="o">=</span><span class="s2">&quot;STATUS&quot;</span> <span class="nv">operation</span><span class="o">=</span><span class="s2">&quot;profile_replace&quot;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;/usr/sbin/mysqld&quot;</span> <span class="nv">pid</span><span class="o">=</span>10919 <span class="nv">comm</span><span class="o">=</span><span class="s2">&quot;apparmor_parser&quot;</span>
</span><span class='line'>Mar 23 16:00:40 HP kernel: <span class="o">[</span> 3898.087415<span class="o">]</span> <span class="nb">type</span><span class="o">=</span>1400 audit<span class="o">(</span>1332514840.103:154<span class="o">)</span>: <span class="nv">apparmor</span><span class="o">=</span><span class="s2">&quot;DENIED&quot;</span> <span class="nv">operation</span><span class="o">=</span><span class="s2">&quot;mknod&quot;</span> <span class="nv">parent</span><span class="o">=</span>1 <span class="nv">profile</span><span class="o">=</span><span class="s2">&quot;/usr/sbin/mysqld&quot;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;/home/neten/mysql/HP.lower-test&quot;</span> <span class="nv">pid</span><span class="o">=</span>10923 <span class="nv">comm</span><span class="o">=</span><span class="s2">&quot;mysqld&quot;</span> <span class="nv">requested_mask</span><span class="o">=</span><span class="s2">&quot;c&quot;</span> <span class="nv">denied_mask</span><span class="o">=</span><span class="s2">&quot;c&quot;</span> <span class="nv">fsuid</span><span class="o">=</span>0 <span class="nv">ouid</span><span class="o">=</span>0
</span><span class='line'>Mar 23 16:00:40 HP kernel: <span class="o">[</span> 3898.087528<span class="o">]</span> <span class="nb">type</span><span class="o">=</span>1400 audit<span class="o">(</span>1332514840.103:155<span class="o">)</span>: <span class="nv">apparmor</span><span class="o">=</span><span class="s2">&quot;DENIED&quot;</span> <span class="nv">operation</span><span class="o">=</span><span class="s2">&quot;mknod&quot;</span> <span class="nv">parent</span><span class="o">=</span>1 <span class="nv">profile</span><span class="o">=</span><span class="s2">&quot;/usr/sbin/mysqld&quot;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;/home/neten/mysql/HP.lower-test&quot;</span> <span class="nv">pid</span><span class="o">=</span>10923 <span class="nv">comm</span><span class="o">=</span><span class="s2">&quot;mysqld&quot;</span> <span class="nv">requested_mask</span><span class="o">=</span><span class="s2">&quot;c&quot;</span> <span class="nv">denied_mask</span><span class="o">=</span><span class="s2">&quot;c&quot;</span> <span class="nv">fsuid</span><span class="o">=</span>0 <span class="nv">ouid</span><span class="o">=</span>0
</span><span class='line'>Mar 23 16:00:40 HP kernel: <span class="o">[</span> 3898.090694<span class="o">]</span> <span class="nb">type</span><span class="o">=</span>1400 audit<span class="o">(</span>1332514840.107:156<span class="o">)</span>: <span class="nv">apparmor</span><span class="o">=</span><span class="s2">&quot;DENIED&quot;</span> <span class="nv">operation</span><span class="o">=</span><span class="s2">&quot;open&quot;</span> <span class="nv">parent</span><span class="o">=</span>1 <span class="nv">profile</span><span class="o">=</span><span class="s2">&quot;/usr/sbin/mysqld&quot;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;/home/neten/mysql/mysql/plugin.frm&quot;</span> <span class="nv">pid</span><span class="o">=</span>10923 <span class="nv">comm</span><span class="o">=</span><span class="s2">&quot;mysqld&quot;</span> <span class="nv">requested_mask</span><span class="o">=</span><span class="s2">&quot;r&quot;</span> <span class="nv">denied_mask</span><span class="o">=</span><span class="s2">&quot;r&quot;</span> <span class="nv">fsuid</span><span class="o">=</span>115 <span class="nv">ouid</span><span class="o">=</span>115
</span><span class='line'>Mar 23 16:00:40 HP kernel: <span class="o">[</span> 3898.112522<span class="o">]</span> <span class="nb">type</span><span class="o">=</span>1400 audit<span class="o">(</span>1332514840.127:157<span class="o">)</span>: <span class="nv">apparmor</span><span class="o">=</span><span class="s2">&quot;DENIED&quot;</span> <span class="nv">operation</span><span class="o">=</span><span class="s2">&quot;open&quot;</span> <span class="nv">parent</span><span class="o">=</span>1 <span class="nv">profile</span><span class="o">=</span><span class="s2">&quot;/usr/sbin/mysqld&quot;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;/home/neten/mysql/ibdata1&quot;</span> <span class="nv">pid</span><span class="o">=</span>10923 <span class="nv">comm</span><span class="o">=</span><span class="s2">&quot;mysqld&quot;</span> <span class="nv">requested_mask</span><span class="o">=</span><span class="s2">&quot;rw&quot;</span> <span class="nv">denied_mask</span><span class="o">=</span><span class="s2">&quot;rw&quot;</span> <span class="nv">fsuid</span><span class="o">=</span>115 <span class="nv">ouid</span><span class="o">=</span>115
</span></code></pre></td></tr></table></div></figure></div></p>
<p>看来是apparmor不认识新朋友， 那就给介绍一下吧：<br />
<div class='bogus-wrapper'><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo vi /etc/apparmor.d/usr.sbin.mysqld
</span><span class='line'>
</span><span class='line'>/home/neten/mysql/ r,
</span><span class='line'>/home/neten/mysql/** rwk,
</span></code></pre></td></tr></table></div></figure></div></p>
<p>重启一下， 一切OK了吧：<br />
<div class='bogus-wrapper'><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo /etc/init.d/apparmor restart
</span><span class='line'><span class="nv">$ </span>sudo /etc/init.d/mysql restart
</span></code></pre></td></tr></table></div></figure></div></p>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[DHL hotline 01803-365365]]></title>
    <link href="http://ZPVIP.github.io/posts/342/"/>
    <updated>2012-03-10T00:00:00+01:00</updated>
    <id>http://ZPVIP.github.io/posts/342</id>
    <content type="html"><![CDATA[<p><span class="caps">DHL</span> Packstation 热线<br />
01803-365365<br />
可以用这个0800替换<br />
0800-4159159</p>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ubuntu precise 12.04 无线网卡 慢 Broadcom brcmsmac]]></title>
    <link href="http://ZPVIP.github.io/posts/341/"/>
    <updated>2012-03-10T00:00:00+01:00</updated>
    <id>http://ZPVIP.github.io/posts/341</id>
    <content type="html"><![CDATA[<p>标题没看懂是正常的， 我写的全是关键字。</p>
<p>装12.04后， 无线网卡网速超级慢。 Google后发现<a href="http://tuxcanfly.appspot.com/2011/10/Ubuntu-11-10-Broadcom-Wifi-driver-43xx">解决方法</a>：</p>
<p>If the output of:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lspci -k | grep  brcmsmac
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>includes:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Kernel driver in use: brcmsmac
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>Then you have this problem too.</p>
<p>To solve this, you&#8217;ll need to install broadcom-sta driver and blacklist the default kernel one.<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install bcmwl-kernel-source
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>Then open /etc/modprobe.d/blacklist-bcm43.conf and add these lines:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>blacklist brcmsmac
</span><span class='line'>blacklist bcma
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>Restart and check that:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lspci -k | grep  wl
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>includes:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Kernel driver in use: wl
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>That should fix your wifi.<br />
Hope ubuntu devs fix this and push out updates soon.</p>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用matlab求应力Sigma]]></title>
    <link href="http://ZPVIP.github.io/posts/339/"/>
    <updated>2011-11-10T00:00:00+01:00</updated>
    <id>http://ZPVIP.github.io/posts/339</id>
    <content type="html"><![CDATA[<p>工字钢沿Z轴向下, <br />
Lz是nx1的Array<br />
Mz是nx2的Vector, Mz(:,1)是x向, Mz(:,2)是y向:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='matlab'><span class='line'>    <span class="c">% Sigma of 9 points</span>
</span><span class='line'>    <span class="c">%     4 ___              ___ 3  </span>
</span><span class='line'>    <span class="c">%       \  \             \  \</span>
</span><span class='line'>    <span class="c">%        \  \8__________7_\  \ </span>
</span><span class='line'>    <span class="c">%  Y+/____\_________9         \</span>
</span><span class='line'>    <span class="c">%    \     \   ______\_______  \</span>
</span><span class='line'>    <span class="c">%           \  \ 5    \     6\  \</span>
</span><span class='line'>    <span class="c">%            \__\      \      \__\</span>
</span><span class='line'>    <span class="c">%           1          _\/         2</span>
</span><span class='line'>    <span class="c">%                        X</span>
</span><span class='line'>    <span class="c">%</span>
</span><span class='line'>    <span class="c">% 9个点坐标</span>
</span><span class='line'>    <span class="n">Points</span> <span class="p">=</span> <span class="p">[...</span>
</span><span class='line'>             <span class="n">B</span><span class="p">,</span>    <span class="n">H</span><span class="o">/</span>2<span class="p">;</span>
</span><span class='line'>             <span class="n">B</span><span class="p">,</span>   <span class="o">-</span><span class="n">H</span><span class="o">/</span>2<span class="p">;</span>
</span><span class='line'>            <span class="o">-</span><span class="n">B</span><span class="p">,</span>   <span class="o">-</span><span class="n">H</span><span class="o">/</span>2<span class="p">;</span>
</span><span class='line'>            <span class="o">-</span><span class="n">B</span><span class="p">,</span>    <span class="n">H</span><span class="o">/</span>2<span class="p">;</span>
</span><span class='line'>             <span class="n">t</span><span class="o">/</span>2<span class="p">,</span>  <span class="n">h</span><span class="o">/</span>2<span class="p">;</span>
</span><span class='line'>             <span class="n">t</span><span class="o">/</span>2<span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span>2<span class="p">;</span>
</span><span class='line'>            <span class="o">-</span><span class="n">t</span><span class="o">/</span>2<span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span>2<span class="p">;</span>
</span><span class='line'>            <span class="o">-</span><span class="n">t</span><span class="o">/</span>2<span class="p">,</span>  <span class="n">h</span><span class="o">/</span>2<span class="p">;</span>
</span><span class='line'>             0<span class="p">,</span>    0<span class="p">;</span>
</span><span class='line'>          <span class="p">];</span>
</span><span class='line'>    <span class="n">Sigma</span> <span class="p">=</span> <span class="p">...</span>
</span><span class='line'>      <span class="nb">repmat</span><span class="p">(</span><span class="n">Lz</span> <span class="o">/</span> <span class="n">area</span><span class="p">,</span>1<span class="p">,</span>9<span class="p">)</span> <span class="p">...</span>
</span><span class='line'>    <span class="o">+</span> <span class="nb">repmat</span><span class="p">(</span><span class="n">Mz</span><span class="p">(:,</span>1<span class="p">),</span>1<span class="p">,</span>9<span class="p">)</span> <span class="p">...</span>
</span><span class='line'>        <span class="o">.*</span> <span class="nb">repmat</span><span class="p">(</span><span class="n">Points</span><span class="p">(:,</span>2<span class="p">),</span>1<span class="p">,</span><span class="nb">length</span><span class="p">(</span><span class="n">Mz</span><span class="p">))</span><span class="o">&#39;</span> <span class="o">/</span> <span class="n">obj</span><span class="p">.</span><span class="n">smaIx</span> <span class="p">...</span>
</span><span class='line'>    <span class="o">-</span> <span class="nb">repmat</span><span class="p">(</span><span class="n">Mz</span><span class="p">(:,</span>2<span class="p">),</span>1<span class="p">,</span>9<span class="p">)</span> <span class="p">...</span>
</span><span class='line'>        <span class="o">.*</span> <span class="nb">repmat</span><span class="p">(</span><span class="n">Points</span><span class="p">(:,</span>1<span class="p">),</span>1<span class="p">,</span><span class="nb">length</span><span class="p">(</span><span class="n">Mz</span><span class="p">))</span><span class="o">&#39;</span> <span class="o">/</span> <span class="n">obj</span><span class="p">.</span><span class="n">smaIy</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>下面附带是个实验:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='matlab'><span class='line'>         <span class="n">a</span> <span class="p">=</span><span class="nb">repmat</span><span class="p">([</span>1<span class="p">:</span>20<span class="p">]</span><span class="o">&#39;</span><span class="p">,</span>1<span class="p">,</span>9<span class="p">);</span>
</span><span class='line'>         <span class="n">b</span> <span class="p">=</span><span class="nb">repmat</span><span class="p">([</span>1<span class="p">:</span>9<span class="p">]</span><span class="o">&#39;</span><span class="p">,</span>1<span class="p">,</span>20<span class="p">);</span>
</span><span class='line'>         <span class="n">a</span> <span class="o">.*</span> <span class="n">b</span><span class="o">&#39;</span>
</span></code></pre></td></tr></table></div></figure></div></notextile></p>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[没有配置用户名的时候git报错信息 ]]></title>
    <link href="http://ZPVIP.github.io/posts/337/"/>
    <updated>2011-10-25T00:00:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/337</id>
    <content type="html"><![CDATA[<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[master 1861d1a] SomeDocuments
</span><span class='line'> Committer: Neten &lt;neten@HP.(none)&gt;
</span><span class='line'>Your name and email address were configured automatically based
</span><span class='line'>on your username and hostname. Please check that they are accurate.
</span><span class='line'>You can suppress this message by setting them explicitly:
</span><span class='line'>
</span><span class='line'>    git config --global user.name &quot;Your Name&quot;
</span><span class='line'>    git config --global user.email you@example.com
</span><span class='line'>
</span><span class='line'>After doing this, you may fix the identity used for this commit with:
</span><span class='line'>
</span><span class='line'>    git commit --amend --reset-author
</span><span class='line'>
</span><span class='line'> 1580 files changed, 205989 insertions(+), 0 deletions(-)
</span></code></pre></td></tr></table></div></figure></div></notextile></p>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SparkleShare]]></title>
    <link href="http://ZPVIP.github.io/posts/335/"/>
    <updated>2011-10-23T00:00:00+02:00</updated>
    <id>http://ZPVIP.github.io/posts/335</id>
    <content type="html"><![CDATA[<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lsb_release -sc
</span><span class='line'>lucid
</span><span class='line'>
</span><span class='line'>git --version
</span><span class='line'>git version 1.7.7
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>我想安装SparkleShare:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p ~/.ssh
</span><span class='line'>sudo add-apt-repository ppa:warp10/sparkleshare
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install sparkleshare libwebkit1.1-cil
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>杯具了:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>正在读取软件包列表... 完成
</span><span class='line'>正在分析软件包的依赖关系树
</span><span class='line'>正在读取状态信息... 完成
</span><span class='line'>git-core 已经是最新的版本了。
</span><span class='line'>有一些软件包无法被安装。如果您用的是 unstable 发行版，这也许是
</span><span class='line'>因为系统无法达到您要求的状态造成的。该版本中可能会有一些您需要的软件
</span><span class='line'>包尚未被创建或是它们已被从新到<span class="o">(</span>Incoming<span class="o">)</span>目录移出。
</span><span class='line'>下列信息可能会对解决问题有所帮助：
</span><span class='line'>
</span><span class='line'>下列软件包有未满足的依赖关系：
</span><span class='line'>  sparkleshare: 依赖: git <span class="o">(</span>&gt;<span class="o">=</span> 1.7.1<span class="o">)</span> 但无法安装它
</span><span class='line'>E: 破损的软件包
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>OK, 升级Git<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo add-apt-repository ppa:git-core/ppa
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install git-core
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p><strong>On the server</strong><br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git init --bare /home/neten/MyBackup.git
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p><strong>On the client(s)</strong><br />
1, 再装一次:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install sparkleshare libwebkit1.1-cil
</span><span class='line'><span class="nb">cd</span> /home/neten
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>2, Install the <span class="caps">SSH</span> client:<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-get install openssh-client
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>3, Generate an <span class="caps">RSA</span> key pair used to authenticate with the server (instead of using a password):<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh-keygen
</span></code></pre></td></tr></table></div></figure></div></notextile><br />
(accept defaults and leave password blank here)</p>
<p>4, Send your <span class="caps">RSA</span> key to your server*(neten is my Username):<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh-copy-id neten@192.168.1.2
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>5, Now you can<br />
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sparkleshare start
</span></code></pre></td></tr></table></div></figure></div></notextile><br />
and a Dialog box should appear.</p>
<p>6, Enter your name and e-mail, click next.</p>
<p>7, Tick &#8220;On my own server:&#8221; and enter neten@192.168.1.2 in the box there.</p>
<p>8, In the &#8220;Folder Name&#8221; field, enter the full server side path to the git repo you created on your server (maybe something like /home/neten/MyBackup.git</p>
<p>9, click Sync</p>]]></content>
  </entry>
  
</feed>
