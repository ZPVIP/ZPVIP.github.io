
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>MongoDB Scaffolding Devise Omniauth CanCan (2) - 简洁的想法</title>
  <meta name="author" content="Peter">

  
  <meta name="description" content="1. Devise
2. Omniauth
3. CanCan Devise 现在安装Devise, 和使用其它数据库一样, 首先在Gemfile加入devise, 然后安装Devise: 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.neten.de/posts/2012/06/06/mongodb-scaffolding-devise-omniauth-cancan-2">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="简洁的想法" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">简洁的想法</a></h1>
  
    <h2>仁爱、喜乐、和平、忍耐、恩慈、良善、信实、温柔、节制</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.neten.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">日志</a></li>
  <li><a href="/blog/archives">归档</a></li>
  <li><a href="/posts/categories/website/">网站工程</a></li>
  <li><a href="/posts/categories/collections/">网文收集</a></li>
  <li><a href="/posts/categories/digitallife/">数字生活</a></li>
  <li><a href="/posts/categories/memories/">路已成歌</a></li>
  <li><a href="/posts/categories/beautifulsongs/">美曲美境</a></li>
  <li><a href="/posts/categories/travel/">忆影斑斓</a></li>
  <li><a href="http://bbs.neten.de">论坛</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">MongoDB Scaffolding Devise Omniauth CanCan (2)</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-06T22:26:00+02:00" pubdate data-updated="true">Jun 6<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><a id="TOP0606"></a>
1. <a href="#Devise">Devise</a><br/>
2. <a href="#Omniauth">Omniauth</a><br/>
3. <a href="#CanCan">CanCan</a></p>

<h2><a id="Devise"></a><a href="#TOP">Devise</a></h2>

<p>现在安装Devise, 和使用其它数据库一样, 首先在Gemfile加入devise, 然后安装Devise:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi Gemfile
</span><span class='line'>...
</span><span class='line'>gem <span class="s1">&#39;devise&#39;</span>,<span class="s1">&#39;2.1.0&#39;</span>
</span><span class='line'>...
</span><span class='line'><span class="nv">$ </span>bundle install
</span><span class='line'>      create  config/initializers/devise.rb
</span><span class='line'>      create  config/locales/devise.en.yml
</span><span class='line'><span class="o">===============================================================================</span>
</span><span class='line'>
</span><span class='line'>Some setup you must <span class="k">do </span>manually <span class="k">if </span>you haven<span class="s1">&#39;t yet:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  1. Ensure you have defined default url options in your environments files. Here</span>
</span><span class='line'><span class="s1">     is an example of default_url_options appropriate for a development environment</span>
</span><span class='line'><span class="s1">     in config/environments/development.rb:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">       config.action_mailer.default_url_options = { :host =&gt; &#39;</span>localhost:3000<span class="err">&#39;</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>     In production, :host should be <span class="nb">set </span>to the actual host of your application.
</span><span class='line'>
</span><span class='line'>  2. Ensure you have defined root_url to *something* in your config/routes.rb.
</span><span class='line'>     For example:
</span><span class='line'>
</span><span class='line'>       root :to <span class="o">=</span>&gt; <span class="s2">&quot;home#index&quot;</span>
</span><span class='line'>
</span><span class='line'>  3. Ensure you have flash messages in app/views/layouts/application.html.erb.
</span><span class='line'>     For example:
</span><span class='line'>
</span><span class='line'>       &lt;p <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;notice&quot;</span>&gt;&lt;%<span class="o">=</span> notice %&gt;&lt;/p&gt;
</span><span class='line'>       &lt;p <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span>&gt;&lt;%<span class="o">=</span> alert %&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>  4. If you are deploying Rails 3.1 on Heroku, you may want to <span class="nb">set</span>:
</span><span class='line'>
</span><span class='line'>       config.assets.initialize_on_precompile <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>
</span><span class='line'><span class="nb">     </span>On config/application.rb forcing your application to not access the DB
</span><span class='line'>     or load models when precompiling your assets.
</span><span class='line'>
</span><span class='line'><span class="o">===============================================================================</span>
</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<p>Devise会知道我们已经安装了Mongoid, 所以它会在<code>config/initializers/devise.rb</code>中加入ORM的支持:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;devise/orm/mongoid&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面建立User model</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails generate devise User
</span><span class='line'>      invoke  mongoid
</span><span class='line'>      create    app/models/user.rb
</span><span class='line'>      insert    app/models/user.rb
</span><span class='line'>      insert    app/models/user.rb
</span><span class='line'>       route  devise_for :users
</span></code></pre></td></tr></table></div></figure>


<p>Devise做的工作在上面已经表现得很清楚了, 一方面在route中增加了<code>devise_for :users</code>，另一方面生成User Model，我们可以在<code>app/models/user.rb</code>中看到Devise已经使用Mongoid了:</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="c1"># Include default devise modules. Others available are:</span>
</span><span class='line'>  <span class="c1"># :token_authenticatable, :confirmable,</span>
</span><span class='line'>  <span class="c1"># :lockable, :timeoutable and :omniauthable</span>
</span><span class='line'>  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Database authenticatable</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span>              <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:encrypted_password</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Recoverable</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:reset_password_token</span><span class="p">,</span>   <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:reset_password_sent_at</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Time</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Rememberable</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:remember_created_at</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Time</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Trackable</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:sign_in_count</span><span class="p">,</span>      <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:current_sign_in_at</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Time</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:last_sign_in_at</span><span class="p">,</span>    <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">Time</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:current_sign_in_ip</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:last_sign_in_ip</span><span class="p">,</span>    <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Confirmable</span>
</span><span class='line'>  <span class="c1"># field :confirmation_token,   :type =&gt; String</span>
</span><span class='line'>  <span class="c1"># field :confirmed_at,         :type =&gt; Time</span>
</span><span class='line'>  <span class="c1"># field :confirmation_sent_at, :type =&gt; Time</span>
</span><span class='line'>  <span class="c1"># field :unconfirmed_email,    :type =&gt; String # Only if using reconfirmable</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Lockable</span>
</span><span class='line'>  <span class="c1"># field :failed_attempts, :type =&gt; Integer, :default =&gt; 0 # Only if lock strategy is :failed_attempts</span>
</span><span class='line'>  <span class="c1"># field :unlock_token,    :type =&gt; String # Only if unlock strategy is :email or :both</span>
</span><span class='line'>  <span class="c1"># field :locked_at,       :type =&gt; Time</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Token authenticatable</span>
</span><span class='line'>  <span class="c1"># field :authentication_token, :type =&gt; String</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Devise由12个Modules组成， 在上面的注释中就有体现， 下面我大致翻译一下各个Module的功用( <a href="https://github.com/plataformatec/devise">原文可以去看官方文档</a> )：</p>

<ol>
<li>Database Authenticatable: 用户验证和登录过程中, 把用户的密码加密然后把加密后的密码存在数据库中。</li>
<li>Token Authenticatable: 基于验证令牌的用户登录方法。</li>
<li>Omniauthable: 添加Omniauth支持。</li>
<li>Confirmable: 通过发E-Mail的方式验证用户帐号是否通过通过认证。</li>
<li>Recoverable: 通过发E-Mail的方式支持用户找回密码。</li>
<li>Registerable: 处理用户注册过程,也可以让他们编辑和销毁他们的帐户。</li>
<li>Rememberable: 通过Cookie来记住用户。</li>
<li>Trackable: 跟踪用户的登录次数、时间和IP地址。</li>
<li>Timeoutable: 假如用户一段时间没有活动， 自动用户处于不登录状态。</li>
<li>Validatable: 用户通过E-Mail和密码登录， 可以自定义，比如使用用户名和密码登录。</li>
<li>Lockable: 几次失败的登录尝试后，锁定用户， 可以在一段时间后通过E-Mail解锁。</li>
<li>Encryptable: 除了内置的Bcrypt(默认)，增加支持认证机制。</li>
</ol>


<p>用E-Mail登录可能不是所有网站都想要的风格，如果想要用用户名登录，我们就可以加一个字段，就像上一篇所说的，如果用MySql或Sqlite之类的，还要<code>rake migrate</code>，但现在，只要添加这个字段就好了：</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">field</span> <span class="ss">:user_name</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>用户表中有很多字段，我们希望在用户登录之前只有少量字段可以用来验证真实用户，所以<code>attr_accessible</code>就只包括用户名、邮件、密码和“记住我”，除此之外，用户名和邮件地址唯一性可以通过<code>validates_uniqueness_of</code>保障。</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_presence_of</span> <span class="ss">:user_name</span>
</span><span class='line'><span class="n">validates_uniqueness_of</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:case_sensitive</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'><span class="n">attr_accessible</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">:remember_me</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们在User Model里面使用了Registerable, 这样我们就可以Devise来生成注册的Views：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">generate</span> <span class="n">devise</span><span class="ss">:views</span>
</span><span class='line'>      <span class="n">invoke</span>  <span class="no">Devise</span><span class="o">::</span><span class="no">Generators</span><span class="o">::</span><span class="no">SharedViewsGenerator</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">shared</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">_links</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">invoke</span>  <span class="n">form_for</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">confirmations</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">confirmations</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">passwords</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">passwords</span><span class="o">/</span><span class="n">edit</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">passwords</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">registrations</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">registrations</span><span class="o">/</span><span class="n">edit</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">registrations</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">sessions</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">sessions</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">unlocks</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">unlocks</span><span class="o">/</span><span class="kp">new</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">invoke</span>  <span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">mailer</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">mailer</span><span class="o">/</span><span class="n">confirmation_instructions</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">mailer</span><span class="o">/</span><span class="n">reset_password_instructions</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span><span class='line'>      <span class="n">create</span>    <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">devise</span><span class="o">/</span><span class="n">mailer</span><span class="o">/</span><span class="n">unlock_instructions</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为我们添加了user_name字段，所以相应地要在Views里面添加这个输入框：</p>

<figure class='code'><figcaption><span>app/views/devise/registrations/edit.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">...</span>
</span><span class='line'><span class="x">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;br /&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;/div&gt;</span>
</span><span class='line'><span class="x">...</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/views/devise/registrations/new.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">...</span>
</span><span class='line'><span class="x">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;br /&gt;</span>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;/div&gt;</span>
</span><span class='line'><span class="x">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为Devise已经集成了创建、编辑和删除用户的Controller，所以我们不用在自己的项目中添加任何代码。</p>

<p>为了在项目首页添加用户注册相关的链接，下面修改首页代码：
首先确定一下哪个是首页</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">root</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;articles#index&#39;</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后再修改相应的View</p>

<figure class='code'><figcaption><span>app/views/articles/index.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div id=&quot;user_nav&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">user_signed_in?</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    Signed in as &lt;strong&gt;</span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;/strong&gt;. Not you?</span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">destroy_user_session_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up&quot;</span><span class="p">,</span> <span class="n">new_user_registration_path</span> <span class="cp">%&gt;</span><span class="x"> or</span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">new_user_session_path</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>把以下代码加入<code>app/views/layouts/application.html.erb</code>的<code>&lt;body&gt;</code>下方</p>

<figure class='code'><figcaption><span>app/views/layouts/application.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;p class=&quot;notice&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="n">notice</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span><span class='line'><span class="x">&lt;p class=&quot;alert&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="n">alert</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>到现在为止，Devise就可以正常动作了。如果还需要用户管理界面之类的，那就请大家自己接着开发吧。</p>

<h2><a id="Omniauth"></a><a href="#TOP">Omniauth</a></h2>

<p>下面继续为项目添加Omniauth。主要参考<a href="https://github.com/plataformatec/devise/wiki/OmniAuth:-Overview">Omniauth-facebook</a>。</p>

<p>首先添加Omniauth到Gemfile，别忘了<code>$ bundle install</code>:</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;omniauth&quot;</span><span class="p">,</span> <span class="s1">&#39;1.1.0&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;omniauth-facebook&quot;</span><span class="p">,</span> <span class="s1">&#39;1.3.0&#39;</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在Devise的初始化文件中定义facebook的一些参数：</p>

<figure class='code'><figcaption><span>config/initializers/devise.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="c1"># ==&gt; OmniAuth</span>
</span><span class='line'><span class="c1"># Add a new OmniAuth provider. Check the wiki for more information on setting</span>
</span><span class='line'><span class="c1"># up on your models and hooks.</span>
</span><span class='line'><span class="c1"># config.omniauth :github, &#39;APP_ID&#39;, &#39;APP_SECRET&#39;, :scope =&gt; &#39;user,public_repo&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;omniauth-facebook&quot;</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="s2">&quot;APP_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;APP_SECRET&quot;</span><span class="p">,</span> <span class="ss">:strategy_class</span> <span class="o">=&gt;</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Strategies</span><span class="o">::</span><span class="no">Facebook</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中&#8221;APP_ID&#8221;和&#8221;APP_SECRET&#8221;要去<a href="https://developers.facebook.com/apps/">Facebook</a>去申请。如果是本地测试，可以把Site URL设为http://localhost:3000/, Site Domain可设为localhost。</p>

<p>Devise 12个Modules之一的:omniauthable要从注释中解放出来了：</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">devise</span> <span class="ss">:omniauthable</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在Devise已经在User Model中加入了两个方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user_omniauth_authorize_path</span><span class="p">(</span><span class="ss">:facebook</span><span class="p">)</span>
</span><span class='line'><span class="n">user_omniauth_callback_path</span><span class="p">(</span><span class="ss">:facebook</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来把<code>Sign in with Facebook</code>的链接加到<code>Sign up</code>和<code>Sign in</code>的后面，这样点击这个链接就会把用户带到Facebook，如果用户成功登录Facebook，那Fackbook会把用户信息返回给开始设定好的Callback方法。</p>

<figure class='code'><figcaption><span>cat app/views/articles/index.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div id=&quot;user_nav&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">user_signed_in?</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  Signed in as &lt;strong&gt;</span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">user_name</span> <span class="cp">%&gt;</span><span class="x">&lt;/strong&gt;. Not you?</span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">destroy_user_session_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up&quot;</span><span class="p">,</span> <span class="n">new_user_registration_path</span> <span class="cp">%&gt;</span><span class="x"> or</span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">new_user_session_path</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in with Facebook&quot;</span><span class="p">,</span> <span class="n">user_omniauth_authorize_path</span><span class="p">(</span><span class="ss">:facebook</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Callback的方法在<code>config/routes.rb</code>中定义：</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:omniauth_callbacks</span> <span class="o">=&gt;</span> <span class="s2">&quot;users/omniauth_callbacks&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>既然定义了Callback是<code>users/omniauth_callbacks</code>，那就要建立相应的文件：</p>

<figure class='code'><figcaption><span>app/controllers/users/omniauth_callbacks_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Users</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">facebook</span>
</span><span class='line'>    <span class="c1"># You need to implement the method below in your model</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_for_facebook_oauth</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">persisted?</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span> <span class="s2">&quot;devise.omniauth_callbacks.success&quot;</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="s2">&quot;Facebook&quot;</span>
</span><span class='line'>      <span class="n">sign_in_and_redirect</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:event</span> <span class="o">=&gt;</span> <span class="ss">:authentication</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="s2">&quot;devise.facebook_data&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">new_user_registration_url</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>从代码中不难发现，所有从Facebook中传来的信息都存在request.env[&#8220;omniauth.auth&#8221;], 从服务器日志来看，具体信息如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;Hashie::Mash</span> <span class="na">email=</span><span class="s">&quot;zhangsan@gmail.com&quot;</span>
</span><span class='line'><span class="na">first_name=</span><span class="s">&quot;三&quot;</span>
</span><span class='line'><span class="na">gender=</span><span class="s">&quot;male&quot;</span>
</span><span class='line'><span class="na">id=</span><span class="s">&quot;100000531508888&quot;</span>
</span><span class='line'><span class="na">last_name=</span><span class="s">&quot;张&quot;</span>
</span><span class='line'><span class="na">link=</span><span class="s">&quot;http://www.facebook.com/profile.php?id=100000531508888&quot;</span>
</span><span class='line'><span class="na">locale=</span><span class="s">&quot;zh_CN&quot;</span>
</span><span class='line'><span class="na">name=</span><span class="s">&quot;张三&quot;</span>
</span><span class='line'><span class="na">timezone=</span><span class="s">2</span>
</span><span class='line'><span class="na">updated_time=</span><span class="s">&quot;2011-06-01T20:26:05+0000&quot;</span>
</span><span class='line'><span class="na">verified=</span><span class="s">true</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面这个Controller中的<code>find_for_facebook_oauth</code>还没有定义呢，把下面的代码添加到User Model里面吧：</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>    <span class="n">where</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_facebook_oauth</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">signed_in_resource</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">access_token</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>      <span class="n">user</span>
</span><span class='line'>    <span class="k">else</span> <span class="c1"># Create a user with a stub password.</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="no">Devise</span><span class="o">.</span><span class="n">friendly_token</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_with_session</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">data</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="s2">&quot;devise.facebook_data&quot;</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">session</span><span class="o">[</span><span class="s2">&quot;devise.facebook_data&quot;</span><span class="o">][</span><span class="s2">&quot;extra&quot;</span><span class="o">][</span><span class="s2">&quot;raw_info&quot;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>好了，重启Web服务，测试一下用Facebook登录吧。</p>

<h2><a id="CanCan"></a><a href="#TOP">CanCan</a></h2>

<p>现在进入最后一个主题<a href="https://github.com/ryanb/cancan">CanCan</a>，也就是权限系统。
第一件事照旧就是Gemfile和<code>$ bundle install</code>，CanCan从版本1.5开始就支持Mongoid了，但在Gemfile中要在CanCan之前包含Mongoid。</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;mongoid&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.4&quot;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;cancan&#39;</span><span class="p">,</span><span class="s1">&#39;1.6.7&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后生成ability.rb文件。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails g cancan:ability
</span><span class='line'>      create  app/models/ability.rb
</span></code></pre></td></tr></table></div></figure>


<p>接下来参考这篇<a href="https://github.com/ryanb/cancan/wiki/Role-Based-Authorization">文章</a>，在User Model中添加一个字段<code>roles_mask</code>, 然后把用户角色的定义加入User Model。</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">field</span> <span class="ss">:roles_mask</span>
</span><span class='line'><span class="no">ROLES</span> <span class="o">=</span> <span class="sx">%w[admin moderator author]</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面的代码是为了给用户getting 和 setting角色的</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">roles</span><span class="o">=</span><span class="p">(</span><span class="n">roles</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">roles_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">roles</span> <span class="o">&amp;</span> <span class="no">ROLES</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="mi">2</span><span class="o">**</span><span class="no">ROLES</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">sum</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">roles</span>
</span><span class='line'>  <span class="no">ROLES</span><span class="o">.</span><span class="n">reject</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>    <span class="p">((</span><span class="n">roles_mask</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="o">**</span><span class="no">ROLES</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">role?</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
</span><span class='line'>  <span class="n">roles</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为项目集成了Devise，所以要把roles这个属性设置为accessible</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">attr_accessible</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">:roles</span>
</span></code></pre></td></tr></table></div></figure>


<p>application.html.erb 中可以加上如下代码，可以用来检查current_user</p>

<figure class='code'><figcaption><span>app/views/layouts/application.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">br</span><span class="sr"> /&gt;</span>
</span><span class='line'><span class="sr">&lt;% if current_user != nil %&gt;</span>
</span><span class='line'><span class="sr">user:&lt;%= current_user.user_name %&gt;&lt;br /</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">user_id</span><span class="p">:</span><span class="o">&lt;</span><span class="sx">%= current_user.id %&gt;&lt;br /&gt;</span>
</span><span class='line'><span class="sx">user_role:&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">roles_mask</span> <span class="sx">%&gt;&lt;br /&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% else %&gt;</span>
</span><span class='line'><span class="sx">&lt;%= &quot;nil user&quot; %&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为前面Article Model没有和User Model里面的user_name联系起来，所以只能用Article里面<code>引用关联 Reference Type Associations</code>的Author Model中的<code>author_id</code>和User Model的<code>user_name</code>比较，如果一样，就让用户可以编辑文章。这只是个CanCan示例，真用起来千万别这么干。</p>

<figure class='code'><figcaption><span>app/models/ability.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Ability</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="c1"># guest user (not logged in)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role?</span> <span class="ss">:admin</span>
</span><span class='line'>      <span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="ss">:all</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="ss">:all</span>
</span><span class='line'>      <span class="n">can</span> <span class="ss">:create</span><span class="p">,</span> <span class="no">Comment</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role?</span><span class="p">(</span><span class="ss">:author</span><span class="p">)</span>
</span><span class='line'>        <span class="n">can</span> <span class="ss">:create</span><span class="p">,</span> <span class="no">Article</span>
</span><span class='line'>        <span class="n">can</span> <span class="ss">:update</span><span class="p">,</span> <span class="no">Article</span> <span class="k">do</span> <span class="o">|</span><span class="n">article</span><span class="o">|</span>
</span><span class='line'>          <span class="n">article</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:author_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">user_name</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后在Article Controller加上一句就可以实现权限控制了</p>

<figure class='code'><figcaption><span>app/controllers/articles_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>   <span class="n">load_and_authorize_resource</span>
</span><span class='line'>   <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了版面好看，在view中加入权限控制也很简单</p>

<figure class='code'><figcaption><span>app/views/articles/index.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% if </span><span class="n">can?</span> <span class="ss">:update</span><span class="p">,</span> <span class="n">article</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;td&gt;</span><span class="o">&lt;</span><span class="sx">%= link_to &#39;Edit&#39;, edit_article_path(article) %&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="sx">&lt;% end %&gt;</span>
</span><span class='line'><span class="sx">&lt;% if can? :destroy, article %&gt;</span>
</span><span class='line'><span class="sx">  &lt;td&gt;&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Destroy&#39;</span><span class="p">,</span> <span class="n">article</span><span class="p">,</span> <span class="n">confirm</span><span class="p">:</span> <span class="s1">&#39;Are you sure?&#39;</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="sx">%&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>至此，这个练习的小站就建好了，比较@_@的是
首先要在http://localhost:3000/authors/ 添加一个用户名，比如neten
然后在http://localhost:3000/articles/new 添加文章的时候选择neten作为Author
最后注册一个Role为Author的用户neten, 这样，neten登录的时候，在http://localhost:3000/看到的文章列表中，他自己发的文章都可以Show，也可以Edit,但不可以destroy，如果用户是admin，那所有的链接都是有效的。</p>

<p>这两篇blog只是自己的学习记录，希望对大家有所帮助，如果设计真实项目还要精细思考一下。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Peter</span></span>

      








  


<time datetime="2012-06-06T22:26:00+02:00" pubdate data-updated="true">Jun 6<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/posts/categories/website/'>Website</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/posts/2012/05/19/mongodb-scaffolding-devise-omniauth-cancan-1/" title="Previous Post: MongoDB Scaffolding Devise Omniauth CanCan (1)">&laquo; MongoDB Scaffolding Devise Omniauth CanCan (1)</a>
      
      
        <a class="basic-alignment right" href="/posts/2012/07/21/fatal-error-stdio-dot-h-file-not-found/" title="Next Post: fatal error: stdio.h file not found">fatal error: stdio.h file not found &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/posts/2014/01/27/install-mysql-using-homebrew/">在 Mac 下用 Homebrew 安装 MySQL</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/10/06/use-ffmpeg-to-burn-subtitles-into-the-video/">Use FFmpeg to burn subtitles into the video</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/02/17/ruby-block-proc-and-lambda/">Ruby -- block Proc and lambda</a>
      </li>
    
      <li class="post">
        <a href="/posts/2012/10/18/mac-os-x-10-dot-8-2-problems-after-update/">Mac OS X 10.8.2 Problems after update</a>
      </li>
    
      <li class="post">
        <a href="/posts/2012/08/02/mac-octopress-ioerror-invalid-python-installation/">Mac Octopress IOError invalid Python installation</a>
      </li>
    
      <li class="post">
        <a href="/posts/2012/08/02/rstudio-non-utf8-warning-message/">RStudio non-UTF8 warning message</a>
      </li>
    
      <li class="post">
        <a href="/posts/2012/08/01/pdf-version-found-1-dot-5-but-allowed-1-dot-4/">PDF version found 1.5 but allowed 1.4</a>
      </li>
    
      <li class="post">
        <a href="/posts/2012/07/21/fatal-error-stdio-dot-h-file-not-found/">fatal error: stdio.h file not found</a>
      </li>
    
      <li class="post">
        <a href="/posts/2012/06/06/mongodb-scaffolding-devise-omniauth-cancan-2/">MongoDB Scaffolding Devise Omniauth CanCan (2)</a>
      </li>
    
      <li class="post">
        <a href="/posts/2012/05/19/mongodb-scaffolding-devise-omniauth-cancan-1/">MongoDB Scaffolding Devise Omniauth CanCan (1)</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>最近评论</h1>
  <script type="text/javascript" src="http://neten.disqus.com/combination_widget.js?num_items=5&hide_mods=0&color=grey&default_tab=recent&excerpt_length=200"></script>
</section>
<section>
  <h1>常用资料</h1>
    <ul id="recent_posts">
      <li class="post">
        <a href="/posts/93">来几个Linux命令</a>
      </li>
      <li class="post">
        <a href="/posts/344">Mysql 改变数据库目录</a>
      </li>
      <li class="post">
        <a href="/posts/254">Latex & TexMakerX</a>
      </li>
      <li class="post">
        <a href="/posts/241">在Ubuntu上通过SSH安装Virtualbox</a>
      </li>
      <li class="post">
        <a href="/posts/73">汉德词典 for MDict & Babylon</a>
      </li>
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2005 - 2016 - Peter - | 
  <span><a href="/posts/94">Impressum</a></span>
  <span class="credit" style="float:right">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'neten';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.neten.de/posts/2012/06/06/mongodb-scaffolding-devise-omniauth-cancan-2/';
        var disqus_url = 'http://blog.neten.de/posts/2012/06/06/mongodb-scaffolding-devise-omniauth-cancan-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











<script type="text/javascript" src="/javascripts/jimdoclockzip.js"></script>
</body>
</html>
